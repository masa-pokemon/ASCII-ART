<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン人狼ゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background-color: #010409;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .chat-message {
            margin-bottom: 0.5rem;
            padding: 0.3rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .message-mine {
            background-color: #238636;
            margin-left: auto;
            text-align: right;
        }
        .message-other {
            background-color: #1f6feb;
            text-align: left;
        }
        .gm-action-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .gm-action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        /* Mobile adjustments */
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
            .chat-container {
                height: 300px;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="container mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-400">リアルタイム人狼 (GM進行型)</h1>

        <!-- ロビー/認証エリア -->
        <div id="lobby-area" class="card p-6 rounded-xl space-y-4">
            <h2 class="text-xl font-semibold mb-3">参加者情報</h2>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <input id="player-name-input" type="text" placeholder="あなたの名前を入力"
                       class="flex-1 p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-2 focus:ring-blue-500">
                <button id="set-name-button"
                        class="px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                    名前を決定
                </button>
            </div>
            <p id="current-user-info" class="text-sm text-gray-400 mt-2 break-all">UserID: 未認証</p>
            <p id="current-name-display" class="font-bold text-lg">現在の名前: N/A</p>

            <hr class="border-gray-700">

            <h2 class="text-xl font-semibold mb-3">ゲーム作成・参加</h2>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <input id="game-id-input" type="text" placeholder="ゲームIDを入力 (例: MOON1)"
                       class="flex-1 p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-2 focus:ring-blue-500">
                <button id="create-game-button"
                        class="px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 gm-action-button">
                    ゲームを作成
                </button>
                <button id="join-game-button"
                        class="px-4 py-3 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150">
                    ゲームに参加
                </button>
            </div>
        </div>

        <!-- ゲームプレイエリア (ロビー参加後表示) -->
        <div id="game-area" class="card p-6 rounded-xl mt-6 hidden">
            <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center">
                <h2 id="game-title" class="text-2xl font-bold text-yellow-300">ゲームID: </h2>
                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <p class="text-sm">現在のフェーズ:</p>
                    <span id="game-status-display" class="px-3 py-1 text-sm font-semibold rounded-full bg-indigo-600">ロビー</span>
                </div>
            </div>

            <!-- プレイヤー情報と役割 -->
            <div class="mb-6 card p-4">
                <p id="your-role" class="text-xl font-extrabold text-red-400 text-center mb-2"></p>
                <p id="role-description" class="text-sm text-gray-400 text-center"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- プレイヤーリスト -->
                <div class="md:col-span-1">
                    <h3 class="text-lg font-semibold mb-3">参加者 (<span id="player-count">0</span>人)</h3>
                    <div id="player-list" class="space-y-2 card p-3 h-64 overflow-y-auto">
                        <!-- プレイヤーカードがここに挿入されます -->
                    </div>
                </div>

                <!-- チャット/アクションエリア -->
                <div class="md:col-span-2 space-y-4">
                    <h3 class="text-lg font-semibold mb-3">議論 & アクション</h3>

                    <!-- メッセージ表示エリア -->
                    <div id="chat-messages" class="chat-container">
                        <!-- メッセージがここに挿入されます -->
                    </div>

                    <!-- メッセージ入力フォーム -->
                    <div id="chat-input-area" class="flex space-x-3">
                        <input id="message-input" type="text" placeholder="メッセージを入力..."
                               class="flex-1 p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500" disabled>
                        <button id="send-message-button"
                                class="px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150" disabled>
                            送信
                        </button>
                    </div>

                    <!-- GMアクションエリア -->
                    <div id="gm-actions" class="pt-4 border-t border-gray-700 space-y-3 hidden">
                        <h3 class="text-lg font-semibold text-red-500">ゲームマスター (GM) コントロール</h3>
                        <div id="gm-buttons" class="flex flex-wrap gap-3">
                            <button id="start-game-button" class="px-4 py-2 bg-pink-700 text-white font-bold rounded-lg hover:bg-pink-800 gm-action-button">
                                ゲーム開始 & 役割決定
                            </button>
                            <button id="next-phase-button" class="px-4 py-2 bg-red-700 text-white font-bold rounded-lg hover:bg-red-800 gm-action-button" disabled>
                                次のフェーズへ
                            </button>
                            <button id="reset-game-button" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 gm-action-button">
                                ゲームリセット
                            </button>
                        </div>
                    </div>

                    <!-- アクション選択エリア (投票や襲撃) -->
                    <div id="action-area" class="pt-4 border-t border-gray-700 space-y-3 hidden">
                        <h3 id="action-title" class="text-lg font-semibold text-orange-400">アクション待ち...</h3>
                        <div id="action-targets" class="flex flex-wrap gap-2">
                            <!-- アクションターゲットボタンがここに挿入されます -->
                        </div>
                    </div>

                    <!-- 結果エリア (innerHTMLで全体を更新) -->
                    <div id="result-area" class="card p-4 bg-yellow-900/30 border-yellow-700 hidden">
                        <!-- 結果コンテンツがここに挿入されます -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal for Alerts/Seer Results (アラート代替) -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div id="modal-content-wrapper" class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-400"></h3>
            <p id="modal-content" class="text-white mb-4"></p>
            <button id="modal-close-button" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">閉じる</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, updateDoc, arrayUnion, runTransaction, getDocs, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreのデバッグログを有効にする
        setLogLevel('Debug');

        // ★★★ ユーザー提供の Firebase 設定を組み込みます ★★★
        const STATIC_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBPMqx8KHacF0XiRLSRztxXiRHoGdXFpCQ",
            authDomain: "talk-to-friends-point.firebaseapp.com",
            projectId: "talk-to-friends-point",
            storageBucket: "talk-to-friends-point.firebaseapp.com",
            messagingSenderId: "1012267135320",
            appId: "1:1012267135320:web:1bb99aa6249c88bfac752d",
            measurementId: "G-RFX7NK1Q28"
        };
        // 環境変数からの設定は無視し、STATIC_FIREBASE_CONFIGを使用します。
        const firebaseConfig = STATIC_FIREBASE_CONFIG;
        
        // __app_id は Firestore のセキュリティルールに必要なので、環境から取得します。
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ★★★ 組み込みここまで ★★★


        // グローバル変数
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let userName = localStorage.getItem('werewolf_user_name') || '';
        let gameId = localStorage.getItem('werewolf_game_id') || '';

        // ゲームの状態を保持するリアクティブオブジェクト
        let gameState = {
            status: 'uninitialized', // lobby, day, night, voting, finished
            phase: 'waiting', // discussion, vote, action, result
            dayCount: 0,
            hostId: null,
            players: {},
            messages: [],
            // 夜のアクションを個別で追跡するフィールドを追加
            werewolfTarget: null, // 人狼のターゲットID
            guardTarget: null,    // 騎士のターゲットID
            lastActionTarget: null, // 昼の投票ターゲットID
            eliminatedId: null,
            winner: null,
            nightActionsCompleted: [], // 夜の行動を完了した能力者のIDリスト
        };

        const GAME_COLLECTION = 'werewolf_games';
        const REQUIRED_NIGHT_ROLES = ['werewolf', 'seer', 'guard']; // 行動が必要な能力者 (wolf_mate, bakerは特殊能力なし/夜行動なし)

        // DOM要素の取得
        const nameInput = document.getElementById('player-name-input');
        const setNameButton = document.getElementById('set-name-button');
        const gameIdInput = document.getElementById('game-id-input');
        const createGameButton = document.getElementById('create-game-button');
        const joinGameButton = document.getElementById('join-game-button');
        const lobbyArea = document.getElementById('lobby-area');
        const gameArea = document.getElementById('game-area');
        const gameTitle = document.getElementById('game-title');
        const gameStatusDisplay = document.getElementById('game-status-display');
        const yourRoleDisplay = document.getElementById('your-role');
        const roleDescription = document.getElementById('role-description');
        const playerListContainer = document.getElementById('player-list');
        const playerCountDisplay = document.getElementById('player-count');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const gmActionsArea = document.getElementById('gm-actions');
        const startGameButton = document.getElementById('start-game-button');
        const nextPhaseButton = document.getElementById('next-phase-button');
        const resetGameButton = document.getElementById('reset-game-button');
        const actionArea = document.getElementById('action-area');
        const actionTitle = document.getElementById('action-title');
        const actionTargetsContainer = document.getElementById('action-targets');
        const resultArea = document.getElementById('result-area');
        
        // モーダル関連のDOM要素を取得
        const customModal = document.getElementById('custom-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalContentWrapper = document.getElementById('modal-content-wrapper');


        // --- 新しい役割マップとヘルパー関数 ---
        function getRoleMap() {
            return {
                werewolf: { name: '人狼', desc: '夜に村人を襲撃できます。', team: 'werewolves' },
                wolf_mate: { name: '人狼の相棒', desc: '人狼陣営です。自分が追放された際、生存者を道連れにします。', team: 'werewolves' }, // 新規追加
                seer: { name: '占い師', desc: '夜に一人を占えます。', team: 'villagers' },
                guard: { name: '騎士', desc: '夜に一人を守れます。守った人が襲撃された場合、死亡を防げます。', team: 'villagers' },
                baker: { name: 'パン屋', desc: '村人陣営です。生存していると、パンの香りで平和なメッセージが流れます。', team: 'villagers' }, // 新規追加
                villager: { name: '村人', desc: '特別な能力はありません。', team: 'villagers' },
                unknown: { name: '未定', desc: 'ゲーム開始までお待ちください。', team: 'unknown' }
            };
        }

        function getRoleDisplayName(roleKey) {
            const roleMap = getRoleMap();
            return roleMap[roleKey] ? roleMap[roleKey].name : '不明';
        }
        // --- ヘルパー関数終わり ---


        // Firebaseの設定と初期化
        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 認証処理
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // 認証トークンがない場合は匿名認証
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (token) {
                            const userCredential = await signInWithCustomToken(auth, token);
                            userId = userCredential.user.uid;
                        } else {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        // 認証失敗時もとりあえずランダムIDを使う
                        userId = crypto.randomUUID();
                    }
                }
                document.getElementById('current-user-info').textContent = `UserID: ${userId}`;
                if (userName) {
                    document.getElementById('current-name-display').textContent = `現在の名前: ${userName}`;
                    document.getElementById('player-name-input').value = userName;
                }
                if (gameId) {
                    joinGame(gameId); // 以前のゲームに自動参加を試みる
                }
            });
        } else {
            console.error("Firebase configuration is missing or invalid.");
            userId = crypto.randomUUID(); // Fallback ID
            document.getElementById('current-user-info').textContent = `UserID: ${userId} (Firebase無効)`;
        }
        
        // =========================================================
        // カスタムモーダル (アラートの代替)
        // =========================================================
        /** カスタムモーダルを表示する */
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = content;
            customModal.classList.remove('hidden');
        }

        /** カスタムモーダルを非表示にする */
        function hideModal() {
            customModal.classList.add('hidden');
        }
        
        // モーダルイベントリスナーの設定
        if (customModal && modalCloseButton && modalContentWrapper) {
            modalCloseButton.addEventListener('click', hideModal);
            customModal.addEventListener('click', (event) => {
                if (event.target === customModal) {
                    hideModal();
                }
            });
            modalContentWrapper.addEventListener('click', (event) => {
                event.stopPropagation();
            });
        }


        // =========================================================
        // ユーザー名設定
        // =========================================================
        setNameButton.addEventListener('click', () => {
            const newName = nameInput.value.trim();
            if (newName.length > 0) {
                userName = newName;
                localStorage.setItem('werewolf_user_name', userName);
                document.getElementById('current-name-display').textContent = `現在の名前: ${userName}`;
            } else {
                console.error('名前を入力してください。');
            }
        });

        // =========================================================
        // ゲーム管理
        // =========================================================

        /** ゲームドキュメントの参照を取得する */
        const getGameDocRef = (id) => {
            if (!db) return null;
            // Public Collection Path: /artifacts/{appId}/public/data/werewolf_games/{gameId}
            return doc(db, 'artifacts', appId, 'public', 'data', GAME_COLLECTION, id);
        };

        /** ゲームを作成する */
        createGameButton.addEventListener('click', async () => {
            if (!userId || !userName) { console.error('先に名前を決定してください。'); return; }
            const newGameId = gameIdInput.value.trim().toUpperCase() || crypto.randomUUID().substring(0, 5).toUpperCase();

            const initialGameData = {
                ...gameState, // gameStateの初期値を展開
                status: 'lobby',
                phase: 'waiting',
                hostId: userId,
                players: {
                    [userId]: { name: userName, isAlive: true, role: 'unknown', votes: 0, isHost: true }
                },
                messages: [{ userId: 'system', name: 'システム', text: `${userName} がゲームを開始しました。`, timestamp: Date.now() }],
            };

            try {
                const gameRef = getGameDocRef(newGameId);
                await setDoc(gameRef, initialGameData);
                gameId = newGameId;
                localStorage.setItem('werewolf_game_id', gameId);
                startListening(gameRef);
                console.log(`ゲーム ${newGameId} を作成しました。`);
            } catch (e) {
                console.error("ゲーム作成エラー:", e);
            }
        });

        /** ゲームに参加する */
        joinGameButton.addEventListener('click', () => {
            if (!userId || !userName) { console.error('先に名前を決定してください。'); return; }
            const targetGameId = gameIdInput.value.trim().toUpperCase();
            if (targetGameId.length === 0) { console.error('参加するゲームIDを入力してください。'); return; }
            joinGame(targetGameId);
        });

        async function joinGame(targetGameId) {
            const gameRef = getGameDocRef(targetGameId);
            if (!gameRef) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);

                    if (!gameDoc.exists()) {
                        throw new Error("指定されたゲームIDは存在しません。");
                    }

                    const currentData = gameDoc.data();
                    if (currentData.status !== 'lobby' && !currentData.players[userId]) {
                        throw new Error("ゲームはすでに開始しており、途中参加はできません。");
                    }

                    const newPlayerEntry = {
                        name: userName,
                        isAlive: true,
                        role: 'unknown',
                        votes: 0,
                        isHost: currentData.hostId === userId
                    };

                    const newPlayers = {
                        ...currentData.players,
                        [userId]: newPlayerEntry
                    };

                    const systemMessage = {
                        userId: 'system',
                        name: 'システム',
                        text: `${userName} がゲームに参加しました。`,
                        timestamp: Date.now()
                    };

                    transaction.update(gameRef, {
                        players: newPlayers,
                        messages: arrayUnion(systemMessage)
                    });

                    gameId = targetGameId;
                    localStorage.setItem('werewolf_game_id', gameId);
                    startListening(gameRef);
                });
                console.log(`ゲーム ${targetGameId} に参加しました。`);
            } catch (e) {
                console.error("ゲーム参加エラー:", e.message);
            }
        }


        let unsubscribe = null;
        /** Firestoreのリアルタイムリスナーを開始する */
        function startListening(gameRef) {
            if (unsubscribe) {
                unsubscribe(); // 既存のリスナーを解除
            }

            unsubscribe = onSnapshot(gameRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    gameState = docSnapshot.data();
                    updateUI();
                    
                    // 自動遷移のチェック (GMのみが実行)
                    if (gameState.hostId === userId && gameState.status === 'night' && gameState.phase === 'action') {
                        checkAutoPhaseTransition(gameState, gameRef);
                    }

                } else {
                    console.log("ゲームドキュメントが存在しません。");
                    gameId = '';
                    localStorage.removeItem('werewolf_game_id');
                    resetUI();
                }
            }, (error) => {
                console.error("Firestoreリスナーエラー:", error);
            });

            lobbyArea.classList.add('hidden');
            gameArea.classList.remove('hidden');
        }

        /** UIの全体更新 */
        function updateUI() {
            gameTitle.textContent = `ゲームID: ${gameId}`;
            gameStatusDisplay.textContent = `${gameState.status === 'day' ? '昼' : gameState.status === 'night' ? '夜' : 'ロビー'} (フェーズ: ${getPhaseName(gameState.phase)}) - Day ${gameState.dayCount}`;
            gameStatusDisplay.className = `px-3 py-1 text-sm font-semibold rounded-full ${gameState.status === 'day' ? 'bg-yellow-600' : gameState.status === 'night' ? 'bg-purple-800' : gameState.status === 'finished' ? 'bg-red-600' : 'bg-indigo-600'}`;

            // 役割と説明の表示
            const player = gameState.players[userId];
            if (player) {
                const roleMap = getRoleMap();
                const currentRole = roleMap[player.role] || roleMap.unknown;
                
                // 役割の色分け
                let roleColor = '#34d399'; // 村人
                if (currentRole.team === 'werewolves') roleColor = '#f87171'; // 人狼陣営
                else if (player.role === 'seer') roleColor = '#60a5fa'; // 占い師
                else if (player.role === 'guard') roleColor = '#fcd34d'; // 騎士
                else if (player.role === 'baker') roleColor = '#f7b731'; // パン屋
                

                yourRoleDisplay.textContent = `あなたの役割: ${currentRole.name} ${player.isAlive ? '' : '(死亡)'}`;
                yourRoleDisplay.style.color = roleColor;
                roleDescription.textContent = currentRole.desc;
            } else {
                 yourRoleDisplay.textContent = 'ゲームに参加していません';
                 roleDescription.textContent = '';
            }

            // GMアクションエリアの制御
            const isHost = gameState.hostId === userId;
            gmActionsArea.classList.toggle('hidden', !isHost);
            startGameButton.disabled = gameState.status !== 'lobby';
            // 夜のアクションフェーズ中は自動遷移のためボタンを無効化
            nextPhaseButton.disabled = gameState.status === 'lobby' || gameState.status === 'finished' || (gameState.status === 'night' && gameState.phase === 'action');
            
            // プレイヤーリストのレンダリング
            renderPlayerList();
            
            // チャットのレンダリング
            renderChatMessages();

            // アクションエリアの制御とレンダリング
            handleActionArea(player);

            // 終了結果の表示
            handleResultArea();
        }

        function getPhaseName(phase) {
            const phaseNames = {
                waiting: '待機中',
                discussion: '議論',
                vote: '投票',
                action: '行動',
                result: '結果発表',
            };
            return phaseNames[phase] || phase;
        }

        /** プレイヤーリストのレンダリング */
        function renderPlayerList() {
            playerListContainer.innerHTML = '';
            const playerEntries = Object.entries(gameState.players);
            playerCountDisplay.textContent = playerEntries.length;

            playerEntries.forEach(([pId, pData]) => {
                const isMine = pId === userId;
                const isHost = pData.isHost;
                const roleName = getRoleDisplayName(pData.role);
                const roleText = (isMine && pData.role !== 'unknown') ? 
                    ` (${roleName})` : '';
                const statusColor = pData.isAlive ? 'bg-green-600' : 'bg-red-800';
                const statusText = pData.isAlive ? '生存' : '死亡';

                const playerCard = document.createElement('div');
                playerCard.className = `flex items-center justify-between p-2 rounded-lg ${isMine ? 'bg-blue-900/50 border border-blue-500' : 'bg-gray-800'} ${pData.isAlive ? '' : 'opacity-50 line-through'}`;
                playerCard.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-base">${pData.name}${isHost ? ' (GM)' : ''}</span>
                        <span class="text-xs text-gray-400 break-all">${pId}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusColor}">${statusText}</span>
                        <span class="text-xs text-yellow-300">${roleText}</span>
                    </div>
                `;
                playerListContainer.appendChild(playerCard);
            });
        }

        /** チャットメッセージのレンダリング */
        function renderChatMessages() {
            chatMessagesContainer.innerHTML = '';
            gameState.messages.forEach(msg => {
                const isMine = msg.userId === userId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isMine ? 'message-mine' : 'message-other'}`;
                messageDiv.textContent = `${msg.name}: ${msg.text}`;
                chatMessagesContainer.appendChild(messageDiv);
            });
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            // チャット入力の有効化
            const isAlive = gameState.players[userId]?.isAlive;
            const canChat = (gameState.status === 'day' && gameState.phase === 'discussion' && isAlive);
            messageInput.disabled = !canChat;
            sendMessageButton.disabled = !canChat;
            messageInput.placeholder = canChat ? 'メッセージを入力...' : (gameState.status === 'night' ? '夜は会話できません...' : 'あなたは死亡しました...');
        }

        /** アクションエリアの処理 (夜の行動や昼の投票) */
        function handleActionArea(player) {
            actionTargetsContainer.innerHTML = '';
            actionArea.classList.add('hidden');

            if (!player || !player.isAlive || gameState.status === 'lobby' || gameState.status === 'finished') {
                return;
            }

            let actionType = null;
            let title = '';

            // 1日目の昼は投票できないようにする
            const isFirstDayVote = (gameState.dayCount === 1 && gameState.status === 'day' && gameState.phase === 'vote');

            if (gameState.status === 'day' && gameState.phase === 'vote' && !isFirstDayVote) {
                actionType = 'vote';
                title = '処刑対象に投票してください';
            } else if (gameState.status === 'night' && gameState.phase === 'action') {
                if (player.role === 'werewolf') {
                    actionType = 'werewolf_attack';
                    title = '襲撃対象を選んでください';
                } else if (player.role === 'seer') {
                    actionType = 'seer_predict';
                    title = '占う対象を選んでください';
                } else if (player.role === 'guard') {
                    actionType = 'guard_protect';
                    title = '守る対象を選んでください';
                }
                // wolf_mate, baker, villager は夜の行動なし
            }
            
            if (isFirstDayVote) {
                 actionArea.classList.remove('hidden');
                 actionTitle.textContent = '1日目の昼は投票できません。GMの指示を待ってください。';
                 return;
            }

            if (!actionType) return;
            
            // 既に夜の行動を完了しているかチェック
            const isNightActionComplete = (gameState.status === 'night' && gameState.phase === 'action' && gameState.nightActionsCompleted.includes(userId));
            if (isNightActionComplete) {
                actionArea.classList.remove('hidden');
                actionTitle.textContent = '行動は完了しました。他の能力者の行動を待っています...';
                return;
            }

            actionArea.classList.remove('hidden');
            actionTitle.textContent = title;

            Object.entries(gameState.players).forEach(([pId, pData]) => {
                // 投票は自分以外で生存している人、夜の行動も自分以外で生存している人
                if (pId !== userId && pData.isAlive) {
                    const button = document.createElement('button');
                    button.className = 'px-4 py-2 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition duration-150 gm-action-button';
                    button.textContent = pData.name;
                    button.addEventListener('click', () => submitAction(pId, actionType));
                    actionTargetsContainer.appendChild(button);
                }
            });
        }

        /** 結果エリアの処理 */
        function handleResultArea() {
            resultArea.classList.add('hidden');
            resultArea.innerHTML = ''; // コンテンツをクリア

            if (gameState.status === 'finished') {
                resultArea.classList.remove('hidden');
                
                const winnerIsVillagers = gameState.winner === 'villagers';
                const winnerText = winnerIsVillagers ? '村人陣営' : '人狼陣営';
                
                const roleMap = getRoleMap();

                // 勝利チームのプレイヤーを抽出
                const winningPlayers = Object.values(gameState.players)
                    .filter(p => roleMap[p.role]?.team === gameState.winner)
                    .map(p => {
                        // 役割名を取得
                        const roleName = getRoleDisplayName(p.role);
                        const status = p.isAlive ? ' (生存)' : ' (死亡)';
                        return `${p.name} (${roleName}${status})`;
                    })
                    .join('、 ');
                
                const resultHtml = `
                    <p class="text-xl font-extrabold text-center ${winnerIsVillagers ? 'text-green-300' : 'text-red-300'} mb-2">
                        ゲーム終了！【${winnerText}】の勝利です！
                    </p>
                    <p class="text-base text-center text-gray-200">
                        <span class="font-bold">勝利プレイヤー:</span>
                        <br class="sm:hidden">
                        ${winningPlayers}
                    </p>
                `;
                
                resultArea.innerHTML = resultHtml; 

            } else if (gameState.phase === 'result' && gameState.eliminatedId) {
                 resultArea.classList.remove('hidden');
                 const eliminatedPlayer = gameState.players[gameState.eliminatedId];
                 const roleName = getRoleDisplayName(eliminatedPlayer.role);
                 
                 const resultHtml = `
                     <p class="text-lg font-bold text-center text-yellow-300">
                         ${eliminatedPlayer.name} が追放されました。正体は【${roleName}】でした。
                     </p>
                 `;
                 resultArea.innerHTML = resultHtml;
            }
        }

        // =========================================================
        // アクション実行 (チャット、投票、夜の行動)
        // =========================================================

        /** チャット送信 */
        sendMessageButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (text.length === 0 || gameState.status !== 'day' || gameState.phase !== 'discussion' || !gameState.players[userId]?.isAlive) return;

            const newMessage = {
                userId: userId,
                name: gameState.players[userId].name,
                text: text,
                timestamp: Date.now()
            };

            try {
                const gameRef = getGameDocRef(gameId);
                await updateDoc(gameRef, {
                    messages: arrayUnion(newMessage)
                });
                messageInput.value = '';
            } catch (e) {
                console.error("メッセージ送信エラー:", e);
            }
        });

        /** 投票・夜の行動の実行 */
        async function submitAction(targetId, actionType) {
            try {
                const gameRef = getGameDocRef(gameId);
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    if (!gameDoc.exists()) return;
                    const currentData = gameDoc.data();

                    const player = currentData.players[userId];
                    if (!player || !player.isAlive || (currentData.nightActionsCompleted && currentData.nightActionsCompleted.includes(userId))) return;

                    let updateFields = {};
                    let isPublicMessage = true; 
                    
                    // 1日目の昼は投票アクションを受け付けない
                    const isFirstDayVoteAttempt = (currentData.dayCount === 1 && currentData.status === 'day' && actionType === 'vote');
                    if (isFirstDayVoteAttempt) {
                        console.log("1日目の昼は投票できません。");
                        return;
                    }


                    if (actionType === 'vote' && currentData.status === 'day' && currentData.phase === 'vote') {
                        // 投票ロジック
                        updateFields.lastActionTarget = targetId;
                        updateFields.systemMessageText = `${player.name} が投票を完了しました。`;
                        isPublicMessage = true;

                    } else if (actionType === 'werewolf_attack' && player.role === 'werewolf' && currentData.status === 'night' && currentData.phase === 'action') {
                        // 人狼の襲撃
                        updateFields.werewolfTarget = targetId;
                        updateFields.nightActionsCompleted = arrayUnion(userId);
                        showModal('人狼の襲撃', `${currentData.players[targetId].name} を襲撃対象として決定しました。他の人狼の行動、または朝を待ってください。`);
                        isPublicMessage = false; 
                        
                    } else if (actionType === 'seer_predict' && player.role === 'seer' && currentData.status === 'night' && currentData.phase === 'action') {
                        // 占い師の占い
                        const targetPlayer = currentData.players[targetId];
                        const isWerewolfTeam = targetPlayer.role === 'werewolf' || targetPlayer.role === 'wolf_mate'; // 人狼の相棒も人狼陣営として占われる
                        const result = isWerewolfTeam ? '人狼' : '人狼ではない';
                        
                        showModal('占い結果', `${targetPlayer.name} の正体は【${result}】でした。`);
                        
                        updateFields.nightActionsCompleted = arrayUnion(userId);
                        isPublicMessage = false; 
                    
                    } else if (actionType === 'guard_protect' && player.role === 'guard' && currentData.status === 'night' && currentData.phase === 'action') {
                        // 騎士の護衛
                        showModal('騎士の護衛', `${currentData.players[targetId].name} を護衛対象として決定しました。朝を待ってください。`);
                        
                        updateFields.guardTarget = targetId;
                        updateFields.nightActionsCompleted = arrayUnion(userId);
                        isPublicMessage = false; 

                    } else {
                        throw new Error('無効なアクションです。');
                    }

                    // チャットに追加するのは公開メッセージの場合のみ
                    const updateObj = {
                         nightActionsCompleted: updateFields.nightActionsCompleted || currentData.nightActionsCompleted,
                         werewolfTarget: updateFields.werewolfTarget !== undefined ? updateFields.werewolfTarget : currentData.werewolfTarget,
                         guardTarget: updateFields.guardTarget !== undefined ? updateFields.guardTarget : currentData.guardTarget,
                         lastActionTarget: updateFields.lastActionTarget !== undefined ? updateFields.lastActionTarget : currentData.lastActionTarget,
                    };
                    
                    if (isPublicMessage && updateFields.systemMessageText) {
                        const newMessage = {
                            userId: 'system',
                            name: 'システム',
                            text: updateFields.systemMessageText,
                            timestamp: Date.now()
                        };
                        updateObj.messages = arrayUnion(newMessage);
                    }
                    
                    transaction.update(gameRef, updateObj);
                });
                console.log('アクションが完了しました。');
            } catch (e) {
                console.error("アクション実行エラー:", e.message);
            }
        }


        // =========================================================
        // GMアクション & 自動遷移ロジック
        // =========================================================

        /** 勝利判定 */
        function checkWinCondition(players) {
            const roleMap = getRoleMap();
            
            const alivePlayers = Object.values(players).filter(p => p.isAlive);
            
            // 人狼陣営 (werewolf, wolf_mate)
            const aliveWerewolvesTeam = alivePlayers.filter(p => roleMap[p.role]?.team === 'werewolves').length;
            // 村人陣営 (villager, seer, guard, baker)
            const aliveVillagersTeam = alivePlayers.filter(p => roleMap[p.role]?.team === 'villagers').length;

            if (aliveWerewolvesTeam === 0) {
                return 'villagers'; // 人狼陣営が全滅
            }
            if (aliveWerewolvesTeam >= aliveVillagersTeam) {
                return 'werewolves'; // 人狼陣営の数が村人陣営の数以上
            }
            return null; // 決着せず
        }
        
        /** 自動フェーズ遷移のチェック（夜の能力者行動完了時） */
        async function checkAutoPhaseTransition(currentData, gameRef) {
            if (currentData.status !== 'night' || currentData.phase !== 'action' || currentData.hostId !== userId) return;

            // プレイヤーオブジェクトをID付きで取得
            const alivePlayers = Object.entries(currentData.players)
                .filter(([, pData]) => pData.isAlive)
                .map(([pId, pData]) => ({ id: pId, ...pData }));

            // 行動が必要な能力者のIDリスト (werewolf, seer, guard)
            const requiredActionPlayerIds = alivePlayers
                .filter(p => REQUIRED_NIGHT_ROLES.includes(p.role))
                .map(p => p.id);

            // 行動完了した能力者IDのSet
            const completedSet = new Set(currentData.nightActionsCompleted || []);

            // 実際に行動が必要なプレイヤーのうち、行動を完了した人数
            const completedCount = requiredActionPlayerIds.filter(id => completedSet.has(id)).length;

            if (requiredActionPlayerIds.length > 0 && completedCount >= requiredActionPlayerIds.length) {
                console.log("全能力者の行動が完了しました。自動で次のフェーズへ移行します...");
                // 自動遷移実行
                await proceedToNextPhase(currentData, gameRef);
            }
        }

        /** フェーズ進行処理 (手動・自動共通) */
        async function proceedToNextPhase(currentData, gameRef) {
            let nextStatus = currentData.status;
            let nextPhase = currentData.phase;
            let nextDayCount = currentData.dayCount;
            let eliminatedId = currentData.eliminatedId;
            let winner = checkWinCondition(currentData.players);
            let systemMessageText = '';
            let newPlayers = { ...currentData.players };

            if (winner) {
                nextStatus = 'finished';
                systemMessageText = `ゲーム終了！${winner === 'werewolves' ? '人狼' : '村人'}陣営の勝利です！`;
            } else if (currentData.status === 'day' && currentData.phase === 'discussion') {
                if (currentData.dayCount === 1) {
                    // 1日目の議論 -> 夜 (投票なし)
                    nextStatus = 'night';
                    nextPhase = 'action';
                    systemMessageText = '1日目の昼は投票なしで終了します。夜になりました。能力者は行動を選択してください。';
                } else {
                    // 2日目以降の議論 -> 投票
                    nextPhase = 'vote';
                    systemMessageText = '議論終了！処刑対象に投票してください。';
                }
            } else if (currentData.status === 'day' && currentData.phase === 'vote') {
                // 投票 -> 投票結果発表
                nextPhase = 'result';
                
                eliminatedId = currentData.lastActionTarget;
                
                if (eliminatedId && newPlayers[eliminatedId]) {
                    const eliminatedPlayer = newPlayers[eliminatedId];
                    const roleName = getRoleDisplayName(eliminatedPlayer.role);
                    
                    eliminatedPlayer.isAlive = false;
                    systemMessageText = `${eliminatedPlayer.name} が追放されました。正体は【${roleName}】でした。`;

                    // ★ 人狼の相棒 (wolf_mate) の道連れロジック ★
                    if (eliminatedPlayer.role === 'wolf_mate') {
                        const alivePlayerIds = Object.entries(newPlayers)
                            .filter(([id, data]) => data.isAlive && id !== eliminatedId)
                            .map(([id]) => id);
                        
                        if (alivePlayerIds.length > 0) {
                            const randomIndex = Math.floor(Math.random() * alivePlayerIds.length);
                            const dochoPlayerId = alivePlayerIds[randomIndex];
                            const dochoPlayer = newPlayers[dochoPlayerId];
                            
                            dochoPlayer.isAlive = false;
                            systemMessageText += `\n【人狼の相棒の道連れ能力発動！】 ${dochoPlayer.name} が犠牲になりました。`;
                        } else {
                             systemMessageText += `\n【人狼の相棒の道連れ能力発動！】しかし、他に生存者がいないため能力は空振りに終わりました。`;
                        }
                    }
                    // ★ ロジック終わり ★

                } else {
                    systemMessageText = '追放者はいませんでした (同数票など)。';
                }
            } else if (currentData.status === 'day' && currentData.phase === 'result') {
                // 結果発表 -> 夜
                winner = checkWinCondition(newPlayers);
                if (winner) {
                    nextStatus = 'finished';
                    systemMessageText = `ゲーム終了！${winner === 'werewolves' ? '人狼' : '村人'}陣営の勝利です！`;
                } else {
                    nextStatus = 'night';
                    nextPhase = 'action';
                    // nextDayCount は夜明けの時にインクリメントされるためここではしない
                    systemMessageText = `${currentData.dayCount}日目の夜になりました。能力者は行動を選択してください。`;
                }
            } else if (currentData.status === 'night' && currentData.phase === 'action') {
                // 夜の行動 -> 翌日の議論
                nextStatus = 'day';
                nextPhase = 'discussion';
                nextDayCount++; // 日数をインクリメント
                
                // ★夜の行動結果を判定★
                const wTarget = currentData.werewolfTarget;
                const gTarget = currentData.guardTarget;
                eliminatedId = null; 
                let nightResultText = '';

                if (wTarget) {
                    if (wTarget === gTarget) {
                        // 騎士が護衛成功
                        nightResultText = `${newPlayers[wTarget].name} が襲撃されましたが、護衛されていたため犠牲者は出ませんでした。`;
                    } else {
                        // 騎士の護衛失敗または護衛なし
                        eliminatedId = wTarget;
                        if (newPlayers[eliminatedId]) {
                            newPlayers[eliminatedId].isAlive = false;
                            nightResultText = `夜の間に ${newPlayers[eliminatedId].name} が犠牲になりました。`;
                        }
                    }
                } else {
                    // 人狼がターゲットを選択しなかった場合
                    nightResultText = `犠牲者はいませんでした。`;
                }

                // ★ パン屋のメッセージを追加 ★
                const bakerAlive = Object.values(newPlayers).some(p => p.role === 'baker' && p.isAlive);
                let bakerMessage = '';
                if (bakerAlive) {
                    bakerMessage = '村中にパンが焼けるいい匂いが漂っています。今日も平和な一日になりそうです。';
                }

                systemMessageText = `${nextDayCount}日目の朝です。${nightResultText} ${bakerMessage}`;
                
                // 夜の行動後に再度勝利判定
                winner = checkWinCondition(newPlayers);
                if (winner) {
                    nextStatus = 'finished';
                    systemMessageText = `ゲーム終了！${winner === 'werewolves' ? '人狼' : '村人'}陣営の勝利です！`;
                } else if (nextStatus === 'day') {
                    systemMessageText += '議論を開始してください。';
                }

            } else {
                return; // 想定外の遷移
            }

            const newMessage = {
                userId: 'system',
                name: 'システム',
                text: systemMessageText,
                timestamp: Date.now()
            };

            const updateData = {
                status: nextStatus,
                phase: nextPhase,
                dayCount: nextDayCount,
                eliminatedId: eliminatedId,
                lastActionTarget: null, 
                werewolfTarget: null, 
                guardTarget: null,    
                messages: arrayUnion(newMessage),
                players: newPlayers,
                winner: winner,
                nightActionsCompleted: [], // 夜が明けるときにリセット
            };

            try {
                await updateDoc(gameRef, updateData);
            } catch (e) {
                console.error("フェーズ進行エラー:", e);
            }
        }
        
        /** ゲーム開始 */
        startGameButton.addEventListener('click', async () => {
            if (gameState.status !== 'lobby' || gameState.hostId !== userId) return;
            const playerCount = Object.keys(gameState.players).length;
            if (playerCount < 3) { console.error('ゲーム開始には最低3人のプレイヤーが必要です。'); return; }

            const newPlayers = assignRoles(gameState.players);

            const initialMessage = {
                userId: 'system',
                name: 'システム',
                text: `ゲームが開始されました！役割が配られました。昼のターンです（1日目）。`,
                timestamp: Date.now()
            };

            try {
                const gameRef = getGameDocRef(gameId);
                await updateDoc(gameRef, {
                    status: 'day',
                    phase: 'discussion',
                    dayCount: 1,
                    players: newPlayers,
                    messages: arrayUnion(initialMessage),
                    winner: null,
                    werewolfTarget: null,
                    guardTarget: null,
                    nightActionsCompleted: [],
                });
            } catch (e) {
                console.error("ゲーム開始エラー:", e);
            }
        });

        /** 役割のランダム割り当て (wolf_mateとbakerを追加) */
        function assignRoles(players) {
            const playerIds = Object.keys(players);
            const playerCount = playerIds.length;
            let roles = [];
            
            // 基本役職
            roles.push('werewolf', 'seer');
            if (playerCount >= 4) {
                roles.push('guard');
            }

            // プレイヤー数による特殊役職の追加
            if (playerCount === 5) {
                // 5人時はパン屋を追加 (人狼1, 占い1, 騎士1, パン屋1)
                roles.push('baker');
            } else if (playerCount >= 6) {
                // 6人以上時は人狼の相棒を追加 (人狼1, 占い1, 騎士1, 相棒1)
                roles.push('wolf_mate');
            }

            // 残りを村人にする
            const requiredVillagers = playerCount - roles.length;
            for (let i = 0; i < requiredVillagers; i++) {
                roles.push('villager');
            }
            
            // 役割数が不足していた場合の緊急処理
            if (roles.length < playerCount) {
                while(roles.length < playerCount) {
                    roles.push('villager');
                }
            }


            // シャッフル
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }

            const newPlayers = { ...players };
            playerIds.forEach((id, index) => {
                newPlayers[id] = { ...newPlayers[id], role: roles[index], isAlive: true };
            });
            return newPlayers;
        }

        /** 次のフェーズへ (GM手動操作) */
        nextPhaseButton.addEventListener('click', async () => {
            if (gameState.hostId !== userId) return;
            // 手動遷移は現在のゲームステートを引数にして実行
            await proceedToNextPhase(gameState, getGameDocRef(gameId));
        });

        /** ゲームリセット (GM操作) */
        resetGameButton.addEventListener('click', async () => {
            if (gameState.hostId !== userId) return;
            // アラートの代わりにモーダルを使うべきですが、GM操作なのでここでは一時的に console.log で代用します
            console.log('ゲームをリセット（削除）します。');

            try {
                await deleteDoc(getGameDocRef(gameId));
                console.log('ゲームをリセットしました。');
                gameId = '';
                localStorage.removeItem('werewolf_game_id');
                if (unsubscribe) unsubscribe();
                resetUI();
            } catch (e) {
                console.error("ゲームリセットエラー:", e);
            }
        });

        /** UIをロビー状態に戻す */
        function resetUI() {
            lobbyArea.classList.remove('hidden');
            gameArea.classList.add('hidden');
            gameTitle.textContent = 'ゲームID: ';
            gameStatusDisplay.textContent = 'ロビー';
            yourRoleDisplay.textContent = '';
            roleDescription.textContent = '';
            gmActionsArea.classList.add('hidden');
            actionArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            playerListContainer.innerHTML = '';
            chatMessagesContainer.innerHTML = '';
            gameState = { status: 'uninitialized', phase: 'waiting', dayCount: 0, hostId: null, players: {}, messages: [], werewolfTarget: null, guardTarget: null, lastActionTarget: null, eliminatedId: null, winner: null, nightActionsCompleted: [] };
        }
    </script>
</body>
</html>
