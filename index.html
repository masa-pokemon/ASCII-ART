<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン人狼ゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background-color: #010409;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .chat-message {
            margin-bottom: 0.5rem;
            padding: 0.3rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        .message-mine {
            background-color: #238636;
            margin-left: auto;
            text-align: right;
        }
        .message-other {
            background-color: #1f6feb;
            text-align: left;
        }
        .gm-action-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        .gm-action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
        }
        /* Mobile adjustments */
        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }
            .chat-container {
                height: 300px;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="container mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-400">リアルタイム人狼 (GM進行型)</h1>

        <!-- ロビー/認証エリア -->
        <div id="lobby-area" class="card p-6 rounded-xl space-y-4">
            <h2 class="text-xl font-semibold mb-3">参加者情報</h2>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <input id="player-name-input" type="text" placeholder="あなたの名前を入力"
                       class="flex-1 p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-2 focus:ring-blue-500">
                <button id="set-name-button"
                        class="px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                    名前を決定
                </button>
            </div>
            <p id="current-user-info" class="text-sm text-gray-400 mt-2 break-all">UserID: 未認証</p>
            <p id="current-name-display" class="font-bold text-lg">現在の名前: N/A</p>

            <hr class="border-gray-700">

            <h2 class="text-xl font-semibold mb-3">ゲーム作成・参加</h2>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <input id="game-id-input" type="text" placeholder="ゲームIDを入力 (例: MOON1)"
                       class="flex-1 p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-2 focus:ring-blue-500">
                <button id="create-game-button"
                        class="px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 gm-action-button">
                    ゲームを作成
                </button>
                <button id="join-game-button"
                        class="px-4 py-3 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150">
                    ゲームに参加
                </button>
            </div>
        </div>

        <!-- ゲームプレイエリア (ロビー参加後表示) -->
        <div id="game-area" class="card p-6 rounded-xl mt-6 hidden">
            <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center">
                <h2 id="game-title" class="text-2xl font-bold text-yellow-300">ゲームID: </h2>
                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <p class="text-sm">現在のフェーズ:</p>
                    <span id="game-status-display" class="px-3 py-1 text-sm font-semibold rounded-full bg-indigo-600">ロビー</span>
                </div>
            </div>

            <!-- プレイヤー情報と役割 -->
            <div class="mb-6 card p-4">
                <p id="your-role" class="text-xl font-extrabold text-red-400 text-center mb-2"></p>
                <p id="role-description" class="text-sm text-gray-400 text-center"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- プレイヤーリスト -->
                <div class="md:col-span-1">
                    <h3 class="text-lg font-semibold mb-3">参加者 (<span id="player-count">0</span>人)</h3>
                    <div id="player-list" class="space-y-2 card p-3 h-64 overflow-y-auto">
                        <!-- プレイヤーカードがここに挿入されます -->
                    </div>
                </div>

                <!-- チャット/アクションエリア -->
                <div class="md:col-span-2 space-y-4">
                    <h3 class="text-lg font-semibold mb-3">議論 & アクション</h3>

                    <!-- メッセージ表示エリア -->
                    <div id="chat-messages" class="chat-container">
                        <!-- メッセージがここに挿入されます -->
                    </div>

                    <!-- メッセージ入力フォーム -->
                    <div id="chat-input-area" class="flex space-x-3">
                        <input id="message-input" type="text" placeholder="メッセージを入力..."
                               class="flex-1 p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-blue-500" disabled>
                        <button id="send-message-button"
                                class="px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150" disabled>
                            送信
                        </button>
                    </div>

                    <!-- GMアクションエリア -->
                    <div id="gm-actions" class="pt-4 border-t border-gray-700 space-y-3 hidden">
                        <h3 class="text-lg font-semibold text-red-500">ゲームマスター (GM) コントロール</h3>
                        <div id="gm-buttons" class="flex flex-wrap gap-3">
                            <button id="start-game-button" class="px-4 py-2 bg-pink-700 text-white font-bold rounded-lg hover:bg-pink-800 gm-action-button">
                                ゲーム開始 & 役割決定
                            </button>
                            <button id="next-phase-button" class="px-4 py-2 bg-red-700 text-white font-bold rounded-lg hover:bg-red-800 gm-action-button" disabled>
                                次のフェーズへ
                            </button>
                            <button id="reset-game-button" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 gm-action-button">
                                ゲームリセット
                            </button>
                        </div>
                    </div>

                    <!-- アクション選択エリア (投票や襲撃) -->
                    <div id="action-area" class="pt-4 border-t border-gray-700 space-y-3 hidden">
                        <h3 id="action-title" class="text-lg font-semibold text-orange-400">アクション待ち...</h3>
                        <div id="action-targets" class="flex flex-wrap gap-2">
                            <!-- アクションターゲットボタンがここに挿入されます -->
                        </div>
                    </div>

                    <!-- 結果エリア -->
                    <div id="result-area" class="card p-4 bg-yellow-900/30 border-yellow-700 hidden">
                        <p id="result-text" class="text-lg font-bold text-center text-yellow-300"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, updateDoc, arrayUnion, runTransaction, getDocs, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreのデバッグログを有効にする
        setLogLevel('Debug');

        // ★★★ ユーザー提供の Firebase 設定を組み込みます ★★★
        const STATIC_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBPMqx8KHacF0XiRLSRztgXiRHoGdXFpCQ",
            authDomain: "talk-to-friends-point.firebaseapp.com",
            projectId: "talk-to-friends-point",
            storageBucket: "talk-to-friends-point.firebaseapp.com",
            messagingSenderId: "1012267135320",
            appId: "1:1012267135320:web:1bb99aa6249c88bfac752d",
            measurementId: "G-RFX7NK1Q28"
        };
        // 環境変数からの設定は無視し、STATIC_FIREBASE_CONFIGを使用します。
        const firebaseConfig = STATIC_FIREBASE_CONFIG;
        
        // __app_id は Firestore のセキュリティルールに必要なので、環境から取得します。
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ★★★ 組み込みここまで ★★★


        // グローバル変数
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let userName = localStorage.getItem('werewolf_user_name') || '';
        let gameId = localStorage.getItem('werewolf_game_id') || '';

        // ゲームの状態を保持するリアクティブオブジェクト
        let gameState = {
            status: 'uninitialized', // lobby, day, night, voting, finished
            phase: 'waiting', // discussion, vote, action, result
            dayCount: 0,
            hostId: null,
            players: {},
            messages: [],
            lastActionTarget: null,
            eliminatedId: null,
            winner: null,
        };

        const GAME_COLLECTION = 'werewolf_games';

        // Firebaseの設定と初期化
        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 認証処理
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // 認証トークンがない場合は匿名認証
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (token) {
                            const userCredential = await signInWithCustomToken(auth, token);
                            userId = userCredential.user.uid;
                        } else {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        // 認証失敗時もとりあえずランダムIDを使う
                        userId = crypto.randomUUID();
                    }
                }
                document.getElementById('current-user-info').textContent = `UserID: ${userId}`;
                if (userName) {
                    document.getElementById('current-name-display').textContent = `現在の名前: ${userName}`;
                    document.getElementById('player-name-input').value = userName;
                }
                if (gameId) {
                    joinGame(gameId); // 以前のゲームに自動参加を試みる
                }
            });
        } else {
            console.error("Firebase configuration is missing or invalid.");
            userId = crypto.randomUUID(); // Fallback ID
            document.getElementById('current-user-info').textContent = `UserID: ${userId} (Firebase無効)`;
        }

        // DOM要素の取得
        const nameInput = document.getElementById('player-name-input');
        const setNameButton = document.getElementById('set-name-button');
        const gameIdInput = document.getElementById('game-id-input');
        const createGameButton = document.getElementById('create-game-button');
        const joinGameButton = document.getElementById('join-game-button');
        const lobbyArea = document.getElementById('lobby-area');
        const gameArea = document.getElementById('game-area');
        const gameTitle = document.getElementById('game-title');
        const gameStatusDisplay = document.getElementById('game-status-display');
        const yourRoleDisplay = document.getElementById('your-role');
        const roleDescription = document.getElementById('role-description');
        const playerListContainer = document.getElementById('player-list');
        const playerCountDisplay = document.getElementById('player-count');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const gmActionsArea = document.getElementById('gm-actions');
        const startGameButton = document.getElementById('start-game-button');
        const nextPhaseButton = document.getElementById('next-phase-button');
        const resetGameButton = document.getElementById('reset-game-button');
        const actionArea = document.getElementById('action-area');
        const actionTitle = document.getElementById('action-title');
        const actionTargetsContainer = document.getElementById('action-targets');
        const resultArea = document.getElementById('result-area');
        const resultText = document.getElementById('result-text');

        // =========================================================
        // ユーザー名設定
        // =========================================================
        setNameButton.addEventListener('click', () => {
            const newName = nameInput.value.trim();
            if (newName.length > 0) {
                userName = newName;
                localStorage.setItem('werewolf_user_name', userName);
                document.getElementById('current-name-display').textContent = `現在の名前: ${userName}`;
            } else {
                alert('名前を入力してください。');
            }
        });

        // =========================================================
        // ゲーム管理
        // =========================================================

        /** ゲームドキュメントの参照を取得する */
        const getGameDocRef = (id) => {
            if (!db) return null;
            // Public Collection Path: /artifacts/{appId}/public/data/werewolf_games/{gameId}
            return doc(db, 'artifacts', appId, 'public', 'data', GAME_COLLECTION, id);
        };

        /** ゲームを作成する */
        createGameButton.addEventListener('click', async () => {
            if (!userId || !userName) { alert('先に名前を決定してください。'); return; }
            const newGameId = gameIdInput.value.trim().toUpperCase() || crypto.randomUUID().substring(0, 5).toUpperCase();

            const initialGameData = {
                status: 'lobby',
                phase: 'waiting',
                dayCount: 0,
                hostId: userId,
                players: {
                    [userId]: { name: userName, isAlive: true, role: 'unknown', votes: 0, isHost: true }
                },
                messages: [{ userId: 'system', name: 'システム', text: `${userName} がゲームを開始しました。`, timestamp: Date.now() }],
                lastActionTarget: null,
                eliminatedId: null,
                winner: null,
            };

            try {
                const gameRef = getGameDocRef(newGameId);
                await setDoc(gameRef, initialGameData);
                gameId = newGameId;
                localStorage.setItem('werewolf_game_id', gameId);
                startListening(gameRef);
                alert(`ゲーム ${newGameId} を作成しました。`);
            } catch (e) {
                console.error("ゲーム作成エラー:", e);
                alert('ゲームの作成中にエラーが発生しました。');
            }
        });

        /** ゲームに参加する */
        joinGameButton.addEventListener('click', () => {
            if (!userId || !userName) { alert('先に名前を決定してください。'); return; }
            const targetGameId = gameIdInput.value.trim().toUpperCase();
            if (targetGameId.length === 0) { alert('参加するゲームIDを入力してください。'); return; }
            joinGame(targetGameId);
        });

        async function joinGame(targetGameId) {
            const gameRef = getGameDocRef(targetGameId);
            if (!gameRef) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);

                    if (!gameDoc.exists()) {
                        throw new Error("指定されたゲームIDは存在しません。");
                    }

                    const currentData = gameDoc.data();
                    if (currentData.status !== 'lobby' && !currentData.players[userId]) {
                        throw new Error("ゲームはすでに開始しており、途中参加はできません。");
                    }

                    const newPlayerEntry = {
                        name: userName,
                        isAlive: true,
                        role: 'unknown',
                        votes: 0,
                        isHost: currentData.hostId === userId
                    };

                    const newPlayers = {
                        ...currentData.players,
                        [userId]: newPlayerEntry
                    };

                    const systemMessage = {
                        userId: 'system',
                        name: 'システム',
                        text: `${userName} がゲームに参加しました。`,
                        timestamp: Date.now()
                    };

                    transaction.update(gameRef, {
                        players: newPlayers,
                        messages: arrayUnion(systemMessage)
                    });

                    gameId = targetGameId;
                    localStorage.setItem('werewolf_game_id', gameId);
                    startListening(gameRef);
                });
                alert(`ゲーム ${targetGameId} に参加しました。`);
            } catch (e) {
                console.error("ゲーム参加エラー:", e.message);
                alert(`ゲーム参加エラー: ${e.message}`);
            }
        }


        let unsubscribe = null;
        /** Firestoreのリアルタイムリスナーを開始する */
        function startListening(gameRef) {
            if (unsubscribe) {
                unsubscribe(); // 既存のリスナーを解除
            }

            unsubscribe = onSnapshot(gameRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    gameState = docSnapshot.data();
                    updateUI();
                } else {
                    console.log("ゲームドキュメントが存在しません。");
                    gameId = '';
                    localStorage.removeItem('werewolf_game_id');
                    resetUI();
                }
            }, (error) => {
                console.error("Firestoreリスナーエラー:", error);
            });

            lobbyArea.classList.add('hidden');
            gameArea.classList.remove('hidden');
        }

        /** UIの全体更新 */
        function updateUI() {
            gameTitle.textContent = `ゲームID: ${gameId}`;
            gameStatusDisplay.textContent = `${gameState.status === 'day' ? '昼' : gameState.status === 'night' ? '夜' : 'ロビー'} (フェーズ: ${getPhaseName(gameState.phase)})`;
            gameStatusDisplay.className = `px-3 py-1 text-sm font-semibold rounded-full ${gameState.status === 'day' ? 'bg-yellow-600' : gameState.status === 'night' ? 'bg-purple-800' : 'bg-indigo-600'}`;

            // 役割と説明の表示
            const player = gameState.players[userId];
            if (player) {
                const roleMap = {
                    werewolf: { name: '人狼', desc: '夜に村人を襲撃できます。' },
                    seer: { name: '占い師', desc: '夜に一人を占えます。' },
                    villager: { name: '村人', desc: '特別な能力はありません。' },
                    unknown: { name: '未定', desc: 'ゲーム開始までお待ちください。' }
                };
                const currentRole = roleMap[player.role] || roleMap.unknown;

                yourRoleDisplay.textContent = `あなたの役割: ${currentRole.name} ${player.isAlive ? '' : '(死亡)'}`;
                yourRoleDisplay.style.color = player.role === 'werewolf' ? '#f87171' : player.role === 'seer' ? '#60a5fa' : '#34d399';
                roleDescription.textContent = currentRole.desc;
            } else {
                 yourRoleDisplay.textContent = 'ゲームに参加していません';
                 roleDescription.textContent = '';
            }

            // GMアクションエリアの制御
            const isHost = gameState.hostId === userId;
            gmActionsArea.classList.toggle('hidden', !isHost);
            startGameButton.disabled = gameState.status !== 'lobby';
            nextPhaseButton.disabled = gameState.status === 'lobby' || gameState.status === 'finished';

            // プレイヤーリストのレンダリング
            renderPlayerList();
            
            // チャットのレンダリング
            renderChatMessages();

            // アクションエリアの制御とレンダリング
            handleActionArea(player);

            // 終了結果の表示
            handleResultArea();
        }

        function getPhaseName(phase) {
            const phaseNames = {
                waiting: '待機中',
                discussion: '議論',
                vote: '投票',
                action: '行動',
                result: '結果発表',
            };
            return phaseNames[phase] || phase;
        }

        /** プレイヤーリストのレンダリング */
        function renderPlayerList() {
            playerListContainer.innerHTML = '';
            const playerEntries = Object.entries(gameState.players);
            playerCountDisplay.textContent = playerEntries.length;

            playerEntries.forEach(([pId, pData]) => {
                const isMine = pId === userId;
                const isHost = pData.isHost;
                const roleText = (isMine && pData.role !== 'unknown') ? ` (${pData.role === 'werewolf' ? '人狼' : pData.role === 'seer' ? '占い' : '村人'})` : '';
                const statusColor = pData.isAlive ? 'bg-green-600' : 'bg-red-800';
                const statusText = pData.isAlive ? '生存' : '死亡';

                const playerCard = document.createElement('div');
                playerCard.className = `flex items-center justify-between p-2 rounded-lg ${isMine ? 'bg-blue-900/50 border border-blue-500' : 'bg-gray-800'} ${pData.isAlive ? '' : 'opacity-50 line-through'}`;
                playerCard.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-base">${pData.name}${isHost ? ' (GM)' : ''}</span>
                        <span class="text-xs text-gray-400 break-all">${pId}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusColor}">${statusText}</span>
                        <span class="text-xs text-yellow-300">${roleText}</span>
                    </div>
                `;
                playerListContainer.appendChild(playerCard);
            });
        }

        /** チャットメッセージのレンダリング */
        function renderChatMessages() {
            chatMessagesContainer.innerHTML = '';
            gameState.messages.forEach(msg => {
                const isMine = msg.userId === userId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isMine ? 'message-mine' : 'message-other'}`;
                messageDiv.textContent = `${msg.name}: ${msg.text}`;
                chatMessagesContainer.appendChild(messageDiv);
            });
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            // チャット入力の有効化
            const isAlive = gameState.players[userId]?.isAlive;
            const canChat = (gameState.status === 'day' && isAlive);
            messageInput.disabled = !canChat;
            sendMessageButton.disabled = !canChat;
            messageInput.placeholder = canChat ? 'メッセージを入力...' : (gameState.status === 'night' ? '夜は会話できません...' : 'あなたは死亡しました...');
        }

        /** アクションエリアの処理 (夜の行動や昼の投票) */
        function handleActionArea(player) {
            actionTargetsContainer.innerHTML = '';
            actionArea.classList.add('hidden');

            if (!player || !player.isAlive || gameState.status === 'lobby' || gameState.status === 'finished') {
                return;
            }

            let actionType = null;
            let title = '';

            if (gameState.status === 'day' && gameState.phase === 'vote') {
                actionType = 'vote';
                title = '処刑対象に投票してください';
            } else if (gameState.status === 'night' && gameState.phase === 'action') {
                if (player.role === 'werewolf') {
                    actionType = 'werewolf_attack';
                    title = '襲撃対象を選んでください';
                } else if (player.role === 'seer') {
                    actionType = 'seer_predict';
                    title = '占う対象を選んでください';
                }
            }

            if (!actionType) return;

            actionArea.classList.remove('hidden');
            actionTitle.textContent = title;

            Object.entries(gameState.players).forEach(([pId, pData]) => {
                // 投票は自分以外で生存している人、夜の行動も自分以外で生存している人
                if (pId !== userId && pData.isAlive) {
                    const button = document.createElement('button');
                    button.className = 'px-4 py-2 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition duration-150 gm-action-button';
                    button.textContent = pData.name;
                    button.addEventListener('click', () => submitAction(pId, actionType));
                    actionTargetsContainer.appendChild(button);
                }
            });
        }

        /** 結果エリアの処理 */
        function handleResultArea() {
            resultArea.classList.add('hidden');
            if (gameState.status === 'finished') {
                resultArea.classList.remove('hidden');
                resultText.textContent = gameState.winner === 'villagers' ? 'ゲーム終了！村人の勝利です！' :
                                         gameState.winner === 'werewolves' ? 'ゲーム終了！人狼の勝利です！' :
                                         'ゲームが終了しました。';
            } else if (gameState.phase === 'result' && gameState.eliminatedId) {
                 resultArea.classList.remove('hidden');
                 const eliminatedPlayer = gameState.players[gameState.eliminatedId];
                 resultText.textContent = `${eliminatedPlayer.name} が追放されました。正体は ${eliminatedPlayer.role === 'werewolf' ? '人狼' : eliminatedPlayer.role === 'seer' ? '占い師' : '村人'} でした。`;
            }
        }

        // =========================================================
        // アクション実行 (チャット、投票、夜の行動)
        // =========================================================

        /** チャット送信 */
        sendMessageButton.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (text.length === 0 || gameState.status !== 'day' || !gameState.players[userId]?.isAlive) return;

            const newMessage = {
                userId: userId,
                name: gameState.players[userId].name,
                text: text,
                timestamp: Date.now()
            };

            try {
                const gameRef = getGameDocRef(gameId);
                await updateDoc(gameRef, {
                    messages: arrayUnion(newMessage)
                });
                messageInput.value = '';
            } catch (e) {
                console.error("メッセージ送信エラー:", e);
            }
        });

        /** 投票・夜の行動の実行 */
        async function submitAction(targetId, actionType) {
            try {
                const gameRef = getGameDocRef(gameId);
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    if (!gameDoc.exists()) return;
                    const currentData = gameDoc.data();

                    const player = currentData.players[userId];
                    if (!player || !player.isAlive) return;

                    let updateData = {};
                    let systemMessageText = '';

                    if (actionType === 'vote' && currentData.status === 'day' && currentData.phase === 'vote') {
                        // 投票ロジック (ここではシンプルに最終ターゲットだけ記録)
                        updateData.lastActionTarget = targetId; // 投票の場合、全員のターゲットをこのフィールドに上書き
                        systemMessageText = `${player.name} が投票を完了しました。`;

                    } else if (actionType === 'werewolf_attack' && player.role === 'werewolf' && currentData.status === 'night' && currentData.phase === 'action') {
                        // 人狼の襲撃 (ここではシンプルにターゲットを記録)
                        updateData.lastActionTarget = targetId;
                        systemMessageText = `${player.name} (人狼) が襲撃対象を決定しました。`;

                    } else if (actionType === 'seer_predict' && player.role === 'seer' && currentData.status === 'night' && currentData.phase === 'action') {
                        // 占い師の占い (結果はプライベートに表示)
                        const targetPlayer = currentData.players[targetId];
                        const result = targetPlayer.role === 'werewolf' ? '人狼' : '人狼ではない';
                        alert(`${targetPlayer.name} を占いました。結果: ${result} でした。`);
                        systemMessageText = `${player.name} (占い師) が占いを完了しました。`;
                        // Firestoreへの書き込みは不要 (結果はクライアントに通知するのみ)
                        return; // 占い師はFirestoreを更新しないためここで終了

                    } else {
                        throw new Error('無効なアクションです。');
                    }

                    // GMにアクション完了を通知
                    const newMessage = {
                        userId: 'system',
                        name: 'システム',
                        text: systemMessageText,
                        timestamp: Date.now()
                    };

                    transaction.update(gameRef, {
                        ...updateData,
                        messages: arrayUnion(newMessage)
                    });
                });
                alert('アクションが完了しました。');
            } catch (e) {
                console.error("アクション実行エラー:", e.message);
                alert(`アクション実行エラー: ${e.message}`);
            }
        }


        // =========================================================
        // GMアクション
        // =========================================================

        /** 役割のランダム割り当て */
        function assignRoles(players) {
            const playerIds = Object.keys(players);
            const roles = ['werewolf', 'seer']; // 必須役割
            const requiredVillagers = playerIds.length - roles.length;
            for (let i = 0; i < requiredVillagers; i++) {
                roles.push('villager');
            }

            // シャッフル
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }

            const newPlayers = { ...players };
            playerIds.forEach((id, index) => {
                newPlayers[id] = { ...newPlayers[id], role: roles[index], isAlive: true };
            });
            return newPlayers;
        }

        /** ゲーム開始 */
        startGameButton.addEventListener('click', async () => {
            if (gameState.status !== 'lobby' || gameState.hostId !== userId) return;
            const playerCount = Object.keys(gameState.players).length;
            if (playerCount < 3) { alert('ゲーム開始には最低3人のプレイヤーが必要です。'); return; }

            const newPlayers = assignRoles(gameState.players);

            const initialMessage = {
                userId: 'system',
                name: 'システム',
                text: `ゲームが開始されました！役割が配られました。昼のターンです（1日目）。`,
                timestamp: Date.now()
            };

            try {
                const gameRef = getGameDocRef(gameId);
                await updateDoc(gameRef, {
                    status: 'day',
                    phase: 'discussion',
                    dayCount: 1,
                    players: newPlayers,
                    messages: arrayUnion(initialMessage),
                    winner: null,
                });
            } catch (e) {
                console.error("ゲーム開始エラー:", e);
            }
        });

        /** 次のフェーズへ (GM操作) */
        nextPhaseButton.addEventListener('click', async () => {
            if (gameState.hostId !== userId) return;

            let nextStatus = gameState.status;
            let nextPhase = gameState.phase;
            let nextDayCount = gameState.dayCount;
            let eliminatedId = null;
            let winner = checkWinCondition(gameState.players);
            let systemMessageText = '';
            let newPlayers = { ...gameState.players };

            if (winner) {
                nextStatus = 'finished';
                systemMessageText = `ゲーム終了！${winner === 'werewolves' ? '人狼' : '村人'}陣営の勝利です！`;
            } else if (gameState.status === 'day' && gameState.phase === 'discussion') {
                // 昼 -> 投票
                nextPhase = 'vote';
                systemMessageText = '議論終了！処刑対象に投票してください。';
            } else if (gameState.status === 'day' && gameState.phase === 'vote') {
                // 投票 -> 投票結果発表
                nextPhase = 'result';
                // TODO: 実際の投票集計ロジックを実装する (ここでは lastActionTarget を追放対象と仮定)
                eliminatedId = gameState.lastActionTarget;
                if (eliminatedId && newPlayers[eliminatedId]) {
                    newPlayers[eliminatedId].isAlive = false;
                    systemMessageText = `${newPlayers[eliminatedId].name} が追放されました。正体は ${newPlayers[eliminatedId].role} でした。`;
                } else {
                    systemMessageText = '追放者はいませんでした (同数票など)。';
                }
            } else if (gameState.status === 'day' && gameState.phase === 'result') {
                // 結果発表 -> 夜
                winner = checkWinCondition(newPlayers);
                if (winner) {
                    nextStatus = 'finished';
                    systemMessageText = `ゲーム終了！${winner === 'werewolves' ? '人狼' : '村人'}陣営の勝利です！`;
                } else {
                    nextStatus = 'night';
                    nextPhase = 'action';
                    systemMessageText = `${nextDayCount}日目の夜になりました。能力者は行動を選択してください。`;
                }
            } else if (gameState.status === 'night' && gameState.phase === 'action') {
                // 夜の行動 -> 翌日の結果発表
                nextStatus = 'day';
                nextPhase = 'result';
                nextDayCount++;
                // TODO: 実際の夜の行動結果を反映 (ここでは lastActionTarget を襲撃対象と仮定)
                eliminatedId = gameState.lastActionTarget;
                if (eliminatedId && newPlayers[eliminatedId]) {
                    newPlayers[eliminatedId].isAlive = false;
                    systemMessageText = `${nextDayCount}日目の朝です。夜の間に ${newPlayers[eliminatedId].name} が犠牲になりました。`;
                } else {
                    systemMessageText = `${nextDayCount}日目の朝です。犠牲者はいませんでした。`;
                }
            } else if (gameState.status === 'night' && gameState.phase === 'result') {
                 // 夜の結果発表 -> 昼の議論 (ここでは結果発表は昼に統合されるため、このフェーズはない)
            } else {
                return; // 想定外の遷移
            }

            const newMessage = {
                userId: 'system',
                name: 'システム',
                text: systemMessageText,
                timestamp: Date.now()
            };

            const updateData = {
                status: nextStatus,
                phase: nextPhase,
                dayCount: nextDayCount,
                eliminatedId: eliminatedId,
                lastActionTarget: null, // アクションターゲットをリセット
                messages: arrayUnion(newMessage),
                players: newPlayers,
                winner: winner,
            };

            try {
                await updateDoc(getGameDocRef(gameId), updateData);
            } catch (e) {
                console.error("フェーズ進行エラー:", e);
            }
        });

        /** 勝利判定 */
        function checkWinCondition(players) {
            const alivePlayers = Object.values(players).filter(p => p.isAlive);
            const aliveWerewolves = alivePlayers.filter(p => p.role === 'werewolf').length;
            const aliveVillagers = alivePlayers.filter(p => p.role !== 'werewolf').length; // 村人陣営

            if (aliveWerewolves === 0) {
                return 'villagers'; // 人狼が全滅
            }
            if (aliveWerewolves >= aliveVillagers) {
                return 'werewolves'; // 人狼の数が村人陣営の数以上
            }
            return null; // 決着せず
        }

        /** ゲームリセット (GM操作) */
        resetGameButton.addEventListener('click', async () => {
            if (gameState.hostId !== userId) return;
            // NOTE: iframe環境ではconfirm()は使えません。ここでは簡易的な実装として残しますが、
            // 実際にはカスタムモーダルUIを使用してください。
            if (!confirm('本当にゲームをリセット（削除）しますか？')) return; 

            try {
                await deleteDoc(getGameDocRef(gameId));
                alert('ゲームをリセットしました。');
                gameId = '';
                localStorage.removeItem('werewolf_game_id');
                if (unsubscribe) unsubscribe();
                resetUI();
            } catch (e) {
                console.error("ゲームリセットエラー:", e);
                alert('ゲームリセット中にエラーが発生しました。');
            }
        });

        /** UIをロビー状態に戻す */
        function resetUI() {
            lobbyArea.classList.remove('hidden');
            gameArea.classList.add('hidden');
            gameTitle.textContent = 'ゲームID: ';
            gameStatusDisplay.textContent = 'ロビー';
            yourRoleDisplay.textContent = '';
            roleDescription.textContent = '';
            gmActionsArea.classList.add('hidden');
            actionArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            playerListContainer.innerHTML = '';
            chatMessagesContainer.innerHTML = '';
            gameState = { status: 'uninitialized', phase: 'waiting', dayCount: 0, hostId: null, players: {}, messages: [], lastActionTarget: null, eliminatedId: null, winner: null };
        }
    </script>
</body>
</html>
