<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseé‡çƒãƒ‰ãƒ³ã‚¸ãƒ£ãƒ© - 2äººå¯¾æˆ¦ï¼†ãƒãƒ£ãƒƒãƒˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, arrayUnion, runTransaction, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
        setLogLevel('debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆCanvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚‚ã®ã‚’å–å¾—ï¼‰
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBPMqx8KHacF0XiRLSRztgXiRHoGdXFpCQ",
            authDomain: "talk-to-friends-point.firebaseapp.com",
            projectId: "talk-to-friends-point",
            storageBucket: "talk-to-friends-point.firebaseapp.com",
            messagingSenderId: "1012267135320",
            appId: "1:1012267135320:web:1bb99aa6249c88bfac752d",
            measurementId: "G-RFX7NK1Q28"
        };
        
        const firebaseConfig = FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : FIREBASE_CONFIG.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebaseã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // ã‚²ãƒ¼ãƒ é–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let roomId = '';
        let roomRef = null;
        let roomData = null;
        let unsubscribeRoom = null;
        let isHost = false; // ãƒ«ãƒ¼ãƒ ä½œæˆè€…ã‹ã©ã†ã‹
        
        let myPlayerIndex = -1; // roomData.playerså†…ã§ã®è‡ªåˆ†ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let playerHand = [];
        let isDrawingPhase = false; // true: ç‰Œã‚’å¼•ã„ãŸç›´å¾Œ (9æšçŠ¶æ…‹), false: ç‰Œã‚’æ¨ã¦ãŸç›´å¾Œ (8æšçŠ¶æ…‹)
        let selectedTileId = null;

        // ã‚²ãƒ¼ãƒ å®šæ•° (é‡çƒãƒ‰ãƒ³ã‚¸ãƒ£ãƒ©ä»•æ§˜)
        const TILE_TYPES = [
            'P1', 'P2', 'P3', 'P4', 'P5', 'P6', 'P7', 'P8', 'P9'
        ]; // é‡çƒãƒã‚¸ã‚·ãƒ§ãƒ³ 1ã€œ9 (æŠ•æ‰‹ã€œãƒ©ã‚¤ãƒˆ)
        const TILE_NAMES = {
            'P1': 'æŠ•', 'P2': 'æ•', 'P3': 'ä¸€', 'P4': 'äºŒ', 'P5': 'ä¸‰', 'P6': 'éŠ', 'P7': 'å·¦', 'P8': 'ä¸­', 'P9': 'å³'
        };
        const SPECIAL_TILE = 'OT'; // å¤§è°·ç‰Œ
        const SPECIAL_TILE_NAME = 'å¤§è°·';

        const TILES_PER_TYPE = 5; // é€šå¸¸ç‰Œã¯å„5æš
        const SPECIAL_TILES_COUNT = 3; // å¤§è°·ç‰Œã¯3æš
        const HAND_SIZE_START = 8;
        const HAND_SIZE_WIN = 9;

        // DOMè¦ç´ ã®å–å¾—
        const lobbyContainer = document.getElementById('lobby-container');
        const gameContainer = document.getElementById('game-container');
        const drawButton = document.getElementById('draw-button');
        const checkButton = document.getElementById('check-button');
        const discardSelectedButton = document.getElementById('discard-selected-button');
        const handContainer = document.getElementById('hand-container');
        const opponentHandContainer = document.getElementById('opponent-hand-container');
        const deckCountDisplay = document.getElementById('deck-count');
        const discardContainer = document.getElementById('discard-container');
        const messageBox = document.getElementById('message-box');
        const connectionStatus = document.getElementById('connection-status');
        const currentTurnDisplay = document.getElementById('current-turn');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // ãƒãƒ£ãƒƒãƒˆé–¢é€£DOMè¦ç´ 
        const messagesList = document.getElementById('messages-list');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // -----------------------------------------------------
        // 1. FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        // -----------------------------------------------------

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // åŒ¿åèªè¨¼
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                    isAuthReady = true;
                    userIdDisplay.textContent = `ã‚ãªãŸã®ID: ${userId}`;
                    displayMessage("èªè¨¼å®Œäº†ã€‚ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã¾ãŸã¯å‚åŠ ã—ã¦ãã ã•ã„ã€‚", 'normal');
                    document.getElementById('loading-message').style.display = 'none';
                    lobbyContainer.style.display = 'block';
                    connectionStatus.textContent = 'åŒæœŸå¾…æ©Ÿä¸­...';
                    connectionStatus.style.backgroundColor = '#ccc';
                });

                // ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ç”¨
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage("FirebaseåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        // -----------------------------------------------------
        // 2. ãƒ«ãƒ¼ãƒ ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
        // -----------------------------------------------------

        function getRoomCollectionRef() {
            // ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: /artifacts/{appId}/public/data/donjara_rooms
            return collection(db, 'artifacts', appId, 'public', 'data', 'donjara_rooms');
        }

        /**
         * ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆæœŸåŒ– (é‡çƒãƒ‰ãƒ³ã‚¸ãƒ£ãƒ©ç‰Œæ§‹æˆ)
         */
        function createInitialRoomData() {
            // å…¨ã¦ã®ç‰Œã‚’ç”Ÿæˆ
            let initialDeck = [];
            
            // é€šå¸¸ç‰Œ (P1-P9 å„5æš)
            for (const type of TILE_TYPES) {
                for (let i = 1; i <= TILES_PER_TYPE; i++) {
                    initialDeck.push(`${type}-${i}`);
                }
            }
            // å¤§è°·ç‰Œ (OT å„3æš)
            for (let i = 1; i <= SPECIAL_TILES_COUNT; i++) {
                 initialDeck.push(`${SPECIAL_TILE}-${i}`);
            }
            shuffle(initialDeck);

            return {
                players: [],
                deck: initialDeck,
                discardedTiles: [],
                currentPlayerId: '',
                status: 'waiting', // 'waiting', 'playing', 'finished'
                messages: [], // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ ¼ç´ç”¨
                lastUpdated: Date.now()
            };
        }

        /**
         * ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã€ãƒ›ã‚¹ãƒˆã¨ã—ã¦å‚åŠ 
         */
        async function createRoom() {
            if (!isAuthReady || !userId) return;

            roomId = crypto.randomUUID().substring(0, 8);
            roomRef = doc(getRoomCollectionRef(), roomId);
            isHost = true;

            try {
                // ãƒ«ãƒ¼ãƒ ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                const roomSnapshot = await getDoc(roomRef);
                if (roomSnapshot.exists()) {
                     // æ—¢ã«ãƒ«ãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯åˆ¥IDã‚’å†è©¦è¡Œã™ã‚‹ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ä¸Šæ›¸ã
                     displayMessage("ãƒ«ãƒ¼ãƒ IDãŒé‡è¤‡ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¾ã™ã€‚", 'error');
                     return;
                }

                await setDoc(roomRef, createInitialRoomData());
                await joinRoom(roomId);
            } catch (error) {
                console.error("ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:", error);
                displayMessage("ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        /**
         * ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
         */
        async function joinRoom(id) {
            if (!isAuthReady || !userId) return;
            roomId = id || document.getElementById('room-id-input').value.trim();
            roomRef = doc(getRoomCollectionRef(), roomId);
            isHost = false; 

            if (!roomId) {
                displayMessage("ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", 'error');
                return;
            }

            try {
                // å‚åŠ å‡¦ç†ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ (ç«¶åˆå›é¿)
                await runTransaction(db, async (transaction) => {
                    const roomSnapshot = await transaction.get(roomRef);
                    if (!roomSnapshot.exists()) {
                        throw new Error(`ãƒ«ãƒ¼ãƒ ID: ${roomId} ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
                    }

                    const currentRoomData = roomSnapshot.data();
                    
                    // å‚åŠ æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                    if (currentRoomData.status !== 'waiting' || currentRoomData.players.length >= 2) {
                        throw new Error("ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å“¡ã‹ã€æ—¢ã«ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã™ã€‚");
                    }
                    
                    const existingPlayer = currentRoomData.players.find(p => p.userId === userId);
                    if (existingPlayer) {
                         // æ—¢ã«ãƒ«ãƒ¼ãƒ ã«ã„ã‚‹å ´åˆã¯ç¶šè¡Œ
                         myPlayerIndex = currentRoomData.players.indexOf(existingPlayer);
                         return;
                    }

                    // 1äººç›®ãªã‚‰ãƒ›ã‚¹ãƒˆã€2äººç›®ãªã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
                    const isNewHost = currentRoomData.players.length === 0;
                    const newPlayer = { userId, hand: [], isHost: isNewHost };
                    const newPlayers = [...currentRoomData.players, newPlayer];
                    myPlayerIndex = newPlayers.length - 1; // è‡ªåˆ†ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š

                    transaction.update(roomRef, {
                        players: newPlayers,
                        lastUpdated: Date.now()
                    });
                    
                    isHost = isNewHost;
                });

                // UIåˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('room-title').textContent = `ãƒ«ãƒ¼ãƒ ID: ${roomId}`;
                lobbyContainer.style.display = 'none';
                gameContainer.style.display = 'flex';
                document.getElementById('game-content').style.display = 'block';

                // ãƒ«ãƒ¼ãƒ ã®å¤‰æ›´ã‚’ç›£è¦–é–‹å§‹
                startRoomListener();
                connectionStatus.textContent = 'åŒæœŸä¸­ (Firebase)';
                connectionStatus.style.backgroundColor = '#4CAF50'; // Green

            } catch (error) {
                console.error("ãƒ«ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`ãƒ«ãƒ¼ãƒ å‚åŠ å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        /**
         * ãƒ«ãƒ¼ãƒ ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– (FirebaseåŒæœŸã®ã‚³ã‚¢)
         */
        function startRoomListener() {
            if (unsubscribeRoom) {
                unsubscribeRoom();
            }
            unsubscribeRoom = onSnapshot(roomRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const oldData = roomData;
                    roomData = docSnapshot.data();
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°
                    const myState = roomData.players.find(p => p.userId === userId);
                    if (myState) {
                        myPlayerIndex = roomData.players.indexOf(myState);
                        playerHand = myState.hand || []; // è‡ªåˆ†ã®æ‰‹ç‰Œã‚’æœ€æ–°ã®Firebaseãƒ‡ãƒ¼ã‚¿ã«åŒæœŸ
                        isHost = myState.isHost; // ãƒ›ã‚¹ãƒˆæ¨©é™ã‚‚åŒæœŸ
                    }
                    
                    // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã®æ‰‹ç‰ŒåˆæœŸåŒ–å‡¦ç†
                    if (roomData.status === 'playing' && (!oldData || oldData.status !== 'playing')) {
                         // ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚ŒãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                         displayMessage("ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã—ã¾ã—ãŸï¼æ‰‹ç‰Œã‚’æ•´ç†ã—ã€ã‚ãªãŸã®ç•ªã‹ã‚‰ç‰Œã‚’å¼•ã„ã¦ãã ã•ã„ã€‚", 'success');
                         // 9æšçŠ¶æ…‹ã®ãƒ•ãƒ©ã‚°è¨­å®š
                         isDrawingPhase = playerHand.length >= HAND_SIZE_WIN;
                    } 
                    
                    // ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã®isDrawingPhaseæ›´æ–°
                    if (oldData && oldData.currentPlayerId !== roomData.currentPlayerId) {
                         if (roomData.currentPlayerId === userId) {
                             // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã«ãªã£ãŸæ™‚ã€æ‰‹ç‰Œã®æšæ•°ã«å¿œã˜ã¦ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¨­å®š
                             isDrawingPhase = playerHand.length >= HAND_SIZE_WIN; // 9æšãªã‚‰true
                             displayMessage("ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚", 'success');
                             selectedTileId = null; // ã‚¿ãƒ¼ãƒ³ãŒå¤‰ã‚ã£ãŸã‚‰é¸æŠè§£é™¤
                         } else {
                              isDrawingPhase = false; // ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ãªã‚‰æç”»ãƒ•ã‚§ãƒ¼ã‚ºã¯ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
                         }
                    }

                    // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®å‡¦ç†
                    if (roomData.status === 'finished') {
                        endGame(roomData.winnerId || null);
                        return;
                    }

                    // ã‚²ãƒ¼ãƒ UIã®æ›´æ–°
                    updateUI(); 
                    updateGameUI(roomData);
                    
                    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ›´æ–°
                    if (roomData.messages) {
                        renderMessages(roomData.messages);
                    }

                } else {
                    displayMessage("ãƒ«ãƒ¼ãƒ ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚", 'error');
                    if (unsubscribeRoom) {
                        unsubscribeRoom();
                        unsubscribeRoom = null;
                    }
                    location.reload(); 
                }
            });
        }
        
        /**
         * ã‚²ãƒ¼ãƒ ã®é–‹å§‹ (ãƒ›ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ)
         */
        async function startGame() {
            if (!isHost || roomData.status !== 'waiting' || roomData.players.length !== 2) return;

            try {
                 await runTransaction(db, async (transaction) => {
                    const currentRoomData = (await transaction.get(roomRef)).data();
                    if (currentRoomData.players.length !== 2) return;

                    const players = currentRoomData.players.map(p => ({ ...p, hand: [] }));
                    let deck = currentRoomData.deck;

                    // 8æšé…ã‚‹
                    for (let i = 0; i < HAND_SIZE_START; i++) {
                        players.forEach(p => {
                            const tile = deck.pop();
                            if(tile) p.hand.push(tile); 
                        });
                    }

                    // å…ˆæ”»ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
                    const startingPlayerId = players[Math.floor(Math.random() * 2)].userId;

                    transaction.update(roomRef, {
                        players: players,
                        deck: deck,
                        currentPlayerId: startingPlayerId,
                        status: 'playing',
                        lastUpdated: Date.now()
                    });
                });
            } catch (error) {
                console.error("ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage("ã‚²ãƒ¼ãƒ é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
            }
        }
        
        // -----------------------------------------------------
        // 3. UI/è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
        // -----------------------------------------------------
        
        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
         */
        function displayMessage(text, type = 'normal') {
            messageBox.textContent = text;
            messageBox.className = '';
            messageBox.classList.add('message-box');
            if (type === 'success') {
                messageBox.classList.add('message-success');
            } else if (type === 'error') {
                messageBox.classList.add('message-error');
            } else {
                 messageBox.classList.add('message-normal');
            }
        }

        /**
         * UIã®æ›´æ–° (ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã«ä¾å­˜)
         */
        function updateGameUI(data) {
            if (!data || data.status !== 'playing') {
                currentTurnDisplay.textContent = 'ã‚²ãƒ¼ãƒ å¾…ã¡';
                currentTurnDisplay.style.backgroundColor = '#ccc';
                drawButton.disabled = true;
                checkButton.disabled = true;
                discardSelectedButton.style.display = 'none';
                document.getElementById('start-game-button').style.display = (isHost && data && data.players.length === 2 && data.status === 'waiting') ? 'inline-block' : 'none';
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤º
                const playersInfo = data ? data.players.map(p => 
                    `${p.userId === userId ? 'ã‚ãªãŸ (Me)' : 'å¯¾æˆ¦ç›¸æ‰‹ (Opponent)'} ${p.isHost ? '(HOST)' : ''}`
                ).join(' / ') : 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 1äºº';
                document.getElementById('player-list').textContent = playersInfo;
                
                return;
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤º
            const playersInfo = data.players.map(p => 
                `${p.userId === userId ? 'ã‚ãªãŸ (Me)' : 'å¯¾æˆ¦ç›¸æ‰‹ (Opponent)'} ${p.isHost ? '(HOST)' : ''}`
            ).join(' / ');
            document.getElementById('player-list').textContent = playersInfo;
            
            const myTurn = data.currentPlayerId === userId;
            const opponentPlayerState = data.players.find(p => p.userId !== userId);
            
            // ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
            currentTurnDisplay.textContent = myTurn ? 'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³' : 'ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³';
            currentTurnDisplay.style.backgroundColor = myTurn ? '#aaffaa' : '#ffaaaa';
            
            // ãƒœã‚¿ãƒ³åˆ¶å¾¡
            // ç‰Œã‚’å¼•ããƒœã‚¿ãƒ³: è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ AND ç‰Œã‚’å¼•ã„ã¦ã„ãªã„çŠ¶æ…‹ AND å±±æœ­ãŒã‚ã‚‹
            drawButton.disabled = !myTurn || isDrawingPhase || data.deck.length === 0 || playerHand.length >= HAND_SIZE_WIN;
            // å½¹åˆ¤å®šãƒœã‚¿ãƒ³: è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ AND ç‰Œã‚’å¼•ã„ãŸçŠ¶æ…‹ (9æš)
            checkButton.disabled = !myTurn || playerHand.length !== HAND_SIZE_WIN; // 8æš+1æš
            // æ¨ã¦ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤º: è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ AND ç‰Œã‚’å¼•ã„ãŸçŠ¶æ…‹ (9æš)
            discardSelectedButton.style.display = (myTurn && isDrawingPhase) ? 'inline-block' : 'none';
            discardSelectedButton.disabled = !selectedTileId;
            
            // å±±æœ­ã¨æ¨ã¦ç‰Œ
            deckCountDisplay.textContent = data.deck.length;
            renderDiscardedTiles(data.discardedTiles);

            // ç›¸æ‰‹ã®æ‰‹ç‰Œ (è£è¿”ã—)
            opponentHandContainer.innerHTML = '';
            if (opponentPlayerState) {
                // ç›¸æ‰‹ã®æ‰‹ç‰Œã®æšæ•°ã ã‘è£è¿”ã—ã®ç‰Œã‚’è¡¨ç¤º
                const opponentHandSize = opponentPlayerState.hand.length;
                for (let i = 0; i < opponentHandSize; i++) {
                    opponentHandContainer.appendChild(Object.assign(document.createElement('div'), { className: 'tile face-down' }));
                }
            }

            // ãƒ›ã‚¹ãƒˆã¯ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('start-game-button').style.display = 'none';
        }

        /**
         * æ‰‹ç‰ŒUIã‚’æ›´æ–°
         */
        function updateUI() {
            // æ‰‹ç‰Œã®è¡¨ç¤ºæ›´æ–°
            handContainer.innerHTML = '';
            // ç‰Œã®ã‚½ãƒ¼ãƒˆ (P1-P9, OT ã®é †ã§)
            playerHand.sort((a, b) => {
                const typeA = a.substring(0, 2);
                const typeB = b.substring(0, 2);
                if (typeA === SPECIAL_TILE && typeB !== SPECIAL_TILE) return 1;
                if (typeA !== SPECIAL_TILE && typeB === SPECIAL_TILE) return -1;
                return a.localeCompare(b);
            });

            playerHand.forEach(tileId => {
                const tileEl = createTileElement(tileId);
                if (tileId === selectedTileId) {
                     tileEl.classList.add('selected');
                }
                handContainer.appendChild(tileEl);
            });
            
            // é¸æŠçŠ¶æ…‹ã®æ›´æ–°ã«å¿œã˜ã¦æ¨ã¦ã‚‹ãƒœã‚¿ãƒ³ã‚’åˆ¶å¾¡
            const selectedTile = handContainer.querySelector('.tile.selected');
            const myTurn = roomData && roomData.currentPlayerId === userId;
            
            discardSelectedButton.style.display = (myTurn && isDrawingPhase) ? 'inline-block' : 'none';
            discardSelectedButton.disabled = !selectedTile;
            
            document.getElementById('hand-count').textContent = playerHand.length;
        }

        /**
         * ç‰ŒDOMè¦ç´ ã®ç”Ÿæˆ
         */
        function createTileElement(tileId, selectable = true) {
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.setAttribute('data-id', tileId);
            const type = tileId.substring(0, 2);
            tile.setAttribute('data-type', type);
            
            if (type === SPECIAL_TILE) {
                tile.textContent = SPECIAL_TILE_NAME;
                tile.classList.add('special-tile');
            } else {
                tile.textContent = TILE_NAMES[type] || type; // ãƒã‚¸ã‚·ãƒ§ãƒ³åã‚’è¡¨ç¤º
            }

            if (selectable) {
                tile.addEventListener('click', handleTileClick);
            }
            return tile;
        }
        
        /**
         * æ¨ã¦ç‰Œã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         */
        function renderDiscardedTiles(tiles) {
            discardContainer.innerHTML = '';
            // æœ€æ–°ã®15æšã‚’è¡¨ç¤º
            tiles.slice(-15).forEach(tileId => {
                 discardContainer.appendChild(createTileElement(tileId, false));
            });
        }

        /**
         * ç‰Œã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç† (é¸æŠ)
         */
        function handleTileClick(event) {
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ã€ã‹ã¤ç‰Œã‚’å¼•ã„ãŸå¾Œ (9æšçŠ¶æ…‹) ã§ã®ã¿é¸æŠå¯èƒ½
            if (!roomData || roomData.currentPlayerId !== userId || !isDrawingPhase) {
                displayMessage("ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã€ç‰Œã‚’å¼•ã„ãŸå¾Œã§ã®ã¿æ¨ã¦ã‚‹ç‰Œã‚’é¸æŠã§ãã¾ã™ã€‚", 'error');
                return;
            }

            const tileElement = event.currentTarget;
            const tileId = tileElement.getAttribute('data-id');

            const isSelected = tileElement.classList.contains('selected');
            
            // å…¨ã¦ãƒªã‚»ãƒƒãƒˆ
            handContainer.querySelectorAll('.tile.selected').forEach(t => t.classList.remove('selected'));
            selectedTileId = null;

            if (!isSelected) {
                // æ–°ã—ãé¸æŠ
                tileElement.classList.add('selected');
                selectedTileId = tileId;
                const tileDisplayName = (tileId.startsWith(SPECIAL_TILE)) ? SPECIAL_TILE_NAME : TILE_NAMES[tileId.substring(0, 2)];
                displayMessage(`${tileDisplayName}ã®ç‰Œã‚’é¸æŠã—ã¾ã—ãŸã€‚ã“ã®ç‰Œã‚’æ¨ã¦ã‚‹ã‹ã€å½¹åˆ¤å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`);
            } else {
                displayMessage("æ¨ã¦ã‚‹ç‰Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
            }
            updateGameUI(roomData); // æ¨ã¦ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
        }
        
        // -----------------------------------------------------
        // 4. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (Firestoreã¸ã®æ›¸ãè¾¼ã¿)
        // -----------------------------------------------------
        
        /**
         * å±±æœ­ã‹ã‚‰ç‰Œã‚’å¼•ã
         */
        async function drawTile() {
            if (!roomData || roomData.currentPlayerId !== userId || isDrawingPhase || roomData.deck.length === 0 || playerHand.length >= HAND_SIZE_WIN) return;
            
            try {
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å±±æœ­ã‹ã‚‰1æšå¼•ã
                await runTransaction(db, async (transaction) => {
                    const currentRoomData = (await transaction.get(roomRef)).data();
                    if (currentRoomData.currentPlayerId !== userId || currentRoomData.deck.length === 0 || currentRoomData.players[myPlayerIndex].hand.length !== HAND_SIZE_START) {
                        throw new Error("ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã¾ãŸã¯å±±æœ­ãŒç©ºã‹ã€æ—¢ã«å¼•ã„ã¦ã„ã¾ã™ã€‚");
                    }

                    const drawnTile = currentRoomData.deck.pop();
                    
                    // è‡ªåˆ†ã®æ‰‹ç‰Œã«ç‰Œã‚’è¿½åŠ 
                    currentRoomData.players[myPlayerIndex].hand.push(drawnTile);

                    transaction.update(roomRef, {
                        deck: currentRoomData.deck,
                        players: currentRoomData.players,
                        lastUpdated: Date.now()
                    });
                });

                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æˆåŠŸå¾Œã€isDrawingPhaseã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§æ›´æ–°ï¼ˆonSnapshotã§ä¸Šæ›¸ãã•ã‚Œã‚‹ãŒå³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ï¼‰
                isDrawingPhase = true;
                selectedTileId = null;
                updateUI();
                updateGameUI(roomData);
                displayMessage("å±±æœ­ã‹ã‚‰ç‰Œã‚’å¼•ãã¾ã—ãŸ (æ‰‹ç‰Œ9æš)ã€‚æ¨ã¦ã‚‹ç‰Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", 'success');

            } catch (error) {
                console.error("ç‰Œã‚’å¼•ãã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`ç‰Œã‚’å¼•ãã®ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

        /**
         * é¸æŠã—ãŸç‰Œã‚’æ¨ã¦ã‚‹
         */
        async function discardSelectedTile() {
            if (!roomData || roomData.currentPlayerId !== userId || !isDrawingPhase || !selectedTileId || playerHand.length !== HAND_SIZE_WIN) return;

            const tileIdToDiscard = selectedTileId;

            try {
                 await runTransaction(db, async (transaction) => {
                    const currentRoomData = (await transaction.get(roomRef)).data();
                    if (currentRoomData.currentPlayerId !== userId || currentRoomData.players[myPlayerIndex].hand.length !== HAND_SIZE_WIN) {
                        throw new Error("ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã¾ãŸã¯æ‰‹ç‰ŒãŒ9æšã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                    }
                    
                    const currentHand = currentRoomData.players[myPlayerIndex].hand;
                    const tileIndex = currentHand.indexOf(tileIdToDiscard);
                    
                    if (tileIndex === -1) {
                         throw new Error("æ¨ã¦ã‚‹ç‰ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    }
                    
                    // Firestoreã®é…åˆ—ã‹ã‚‰å‰Šé™¤
                    currentHand.splice(tileIndex, 1);
                    currentRoomData.discardedTiles.push(tileIdToDiscard);

                    // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’æ±ºå®š
                    const opponent = currentRoomData.players.find(p => p.userId !== userId);
                    const nextPlayerId = opponent.userId;

                    transaction.update(roomRef, {
                        players: currentRoomData.players,
                        discardedTiles: currentRoomData.discardedTiles,
                        currentPlayerId: nextPlayerId, // ã‚¿ãƒ¼ãƒ³ã‚’ç›¸æ‰‹ã«æ¸¡ã™
                        lastUpdated: Date.now()
                    });
                });

                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æˆåŠŸå¾Œã®ãƒ­ãƒ¼ã‚«ãƒ«UIæ›´æ–°ï¼ˆonSnapshotã§ä¸Šæ›¸ãã•ã‚Œã‚‹ãŒå³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ï¼‰
                isDrawingPhase = false;
                selectedTileId = null;
                updateUI();
                updateGameUI(roomData);
                const tileDisplayName = (tileIdToDiscard.startsWith(SPECIAL_TILE)) ? SPECIAL_TILE_NAME : TILE_NAMES[tileIdToDiscard.substring(0, 2)];
                displayMessage(`${tileDisplayName}ã‚’æ¨ã¦ã¾ã—ãŸã€‚ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`);

            } catch (error) {
                 console.error("ç‰Œã‚’æ¨ã¦ã‚‹ã‚¨ãƒ©ãƒ¼:", error);
                 displayMessage(`ç‰Œã‚’æ¨ã¦ã‚‹ã®ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
            }
        }

        /**
         * å½¹ã®åˆ¤å®šã‚’å®Ÿè¡Œ
         */
        async function checkHandForYaku() {
            if (!roomData || roomData.currentPlayerId !== userId || playerHand.length !== HAND_SIZE_WIN) return;

            const isYaku = checkYaku(playerHand);

            if (isYaku) {
                displayMessage("ğŸ‰ å½¹ãŒæˆç«‹ã—ã¾ã—ãŸï¼ã‚ãªãŸã®å‹ã¡ã§ã™ï¼ ğŸ‰", 'success');
                // ã‚²ãƒ¼ãƒ çµ‚äº†ã‚’Firestoreã«æ›¸ãè¾¼ã¿
                await updateDoc(roomRef, { 
                    status: 'finished', 
                    winnerId: userId 
                });
            } else {
                displayMessage("å½¹ã¯æˆç«‹ã—ã¦ã„ã¾ã›ã‚“ã€‚åˆ¥ã®ç‰Œã‚’æ¨ã¦ã‚‹ã‹ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", 'error');
            }
        }
        
        /**
         * å½¹ã®åˆ¤å®š (9æšã®æ‰‹ç‰Œã‹ã‚‰1æšã‚’é¸ã³ã€æ®‹ã‚Šã®8æšãŒ3æšçµ„2ã¤ã¨2æšçµ„1ã¤ã§æ§‹æˆå¯èƒ½ã‹ã‚’ç°¡æ˜“åˆ¤å®š)
         */
        function checkYaku(hand) {
            // 9æšã®æ‰‹ç‰Œã§ã€1æšã‚’æ¨ã¦ãŸæ®‹ã‚Š8æšãŒã€Œ3æšçµ„Ã—2ã€ã¨ã€Œé›€é ­(2æšçµ„)Ã—1ã€ã§æ§‹æˆå¯èƒ½ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚
            // å¤§è°·ç‰Œã¯ã‚ªãƒ¼ãƒ«ãƒã‚¤ãƒ†ã‚£ã¨ã—ã¦ä½¿ç”¨å¯èƒ½ã€‚

            if (hand.length !== HAND_SIZE_WIN) return false;
            
            // 9æšã®æ‰‹ç‰Œã‹ã‚‰1æšãšã¤é¸ã³ã€æ®‹ã‚Šã®8æšã§å½¹åˆ¤å®š
            for (let i = 0; i < hand.length; i++) {
                const eightTiles = [...hand.slice(0, i), ...hand.slice(i + 1)];
                if (canFormYaku(eightTiles)) {
                    return true;
                }
            }
            return false;
        }

        /**
         * 8æšã®æ‰‹ç‰ŒãŒã€Œ3æšçµ„Ã—2ã€ã¨ã€Œé›€é ­(2æšçµ„)Ã—1ã€ã§æ§‹æˆå¯èƒ½ã‹ã‚’åˆ¤å®š
         */
        function canFormYaku(hand) {
             if (hand.length !== 8) return false;

             // ç‰Œã®ç¨®é¡ã¨ãã®æšæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
             const counts = {};
             let otaniCount = 0;
             hand.forEach(id => {
                 const type = id.substring(0, 2);
                 if (type === SPECIAL_TILE) {
                     otaniCount++;
                 } else {
                     counts[type] = (counts[type] || 0) + 1;
                 }
             });

             const uniqueTypes = Object.keys(counts).sort((a, b) => a.localeCompare(b));
             const allTypes = [...uniqueTypes, SPECIAL_TILE];

             // é›€é ­ï¼ˆ2æšçµ„ï¼‰ã‚’æ¢ã™
             for (const headType of allTypes) {
                 let tempOtaniCount = otaniCount;
                 let canFormHead = false;

                 if (headType === SPECIAL_TILE) {
                     // é›€é ­ã‚’å¤§è°·ç‰Œ2æšã§æ§‹æˆ (ã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚)
                     if (tempOtaniCount >= 2) {
                         tempOtaniCount -= 2;
                         canFormHead = true;
                     }
                 } else {
                     // é›€é ­ã‚’é€šå¸¸ç‰Œ2æšã§æ§‹æˆ
                     if (counts[headType] >= 2) {
                         counts[headType] -= 2;
                         canFormHead = true;
                     } 
                     // é›€é ­ã‚’é€šå¸¸ç‰Œ1æš+å¤§è°·ç‰Œ1æšã§æ§‹æˆ
                     else if (counts[headType] >= 1 && tempOtaniCount >= 1) {
                         counts[headType] -= 1;
                         tempOtaniCount -= 1;
                         canFormHead = true;
                     } 
                 }
                 
                 if (canFormHead) {
                     // é›€é ­ã‚’é™¤ã„ãŸæ®‹ã‚Šã®6æšï¼ˆ3æšçµ„Ã—2ï¼‰ã§æ§‹æˆå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                     const remainingTiles = [];
                     for (const type of uniqueTypes) {
                          for (let i = 0; i < counts[type]; i++) {
                              remainingTiles.push(type); // ç‰Œã‚¿ã‚¤ãƒ—ã®ã¿ã‚’æ¸¡ã™
                          }
                     }
                     
                     // æ®‹ã‚Š6æšï¼ˆ3æšçµ„Ã—2ï¼‰ã§æ§‹æˆå¯èƒ½ã‹å†å¸°çš„ã«ãƒã‚§ãƒƒã‚¯
                     if (canFormSets(remainingTiles, tempOtaniCount)) {
                          return true;
                     }
                     
                     // ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯ (countsã¨tempOtaniCountã‚’å…ƒã«æˆ»ã™)
                     if (headType === SPECIAL_TILE) {
                         // ãªã—
                     } else if (counts[headType] <= (TILES_PER_TYPE - 2) && canFormHead && tempOtaniCount !== otaniCount) {
                         counts[headType] += 1;
                         // å¤§è°·ç‰Œã‚’1æšä½¿ã£ãŸå ´åˆ
                     } else if (counts[headType] <= (TILES_PER_TYPE - 1) && canFormHead && tempOtaniCount === otaniCount) {
                         counts[headType] += 2;
                         // å¤§è°·ç‰Œã‚’ä½¿ã‚ãªã‹ã£ãŸå ´åˆ
                     }
                 }
             }

             return false;
        }
        
        /**
         * æ®‹ã‚Šã®æ‰‹ç‰ŒãŒå…¨ã¦3æšçµ„ã§æ§‹æˆå¯èƒ½ã‹ã‚’ãƒã‚§ãƒƒã‚¯ (6æšç”¨) - å¤§è°·ç‰Œå¯¾å¿œç‰ˆ
         */
        function canFormSets(tiles, otaniCount) {
             if (tiles.length === 0) return otaniCount === 0;
             if ((tiles.length + otaniCount) % 3 !== 0) return false; 

             const counts = {};
             tiles.forEach(type => {
                 counts[type] = (counts[type] || 0) + 1;
             });

             const sortedTypes = Object.keys(counts).sort((a, b) => a.localeCompare(b));
             const firstType = sortedTypes.find(type => counts[type] > 0);
             if (!firstType) return otaniCount === 0;

             let result = false;

             // 1. åˆ»å­ (3æš) - é€šå¸¸ç‰Œã®ã¿ã§æ§‹æˆ
             if (counts[firstType] >= 3) {
                 counts[firstType] -= 3;
                 const nextTiles = [];
                 for (const type in counts) {
                     for (let i = 0; i < counts[type]; i++) {
                         nextTiles.push(type);
                     }
                 }
                 result = canFormSets(nextTiles, otaniCount);
                 counts[firstType] += 3; // backtrack
                 if (result) return true;
             }

             // 2. åˆ»å­ (3æš) - å¤§è°·ç‰Œã‚’ä½¿ç”¨ã—ã¦æ§‹æˆ (2æš+å¤§è°·1 or 1æš+å¤§è°·2)
             if (otaniCount > 0 && counts[firstType] >= 2) {
                 counts[firstType] -= 2;
                 const nextTiles = [];
                 for (const type in counts) {
                     for (let i = 0; i < counts[type]; i++) {
                         nextTiles.push(type);
                     }
                 }
                 result = canFormSets(nextTiles, otaniCount - 1);
                 counts[firstType] += 2; // backtrack
                 if (result) return true;
             }
             if (otaniCount > 1 && counts[firstType] >= 1) {
                 counts[firstType] -= 1;
                 const nextTiles = [];
                 for (const type in counts) {
                     for (let i = 0; i < counts[type]; i++) {
                         nextTiles.push(type);
                     }
                 }
                 result = canFormSets(nextTiles, otaniCount - 2);
                 counts[firstType] += 1; // backtrack
                 if (result) return true;
             }
             // 3. é †å­ (é€£ç•ª3æš P1, P2, P3) - å¤§è°·ç‰Œãªã—
             const num1 = parseInt(firstType.substring(1));
             if (firstType.startsWith('P') && num1 >= 1 && num1 <= 7) {
                 const type2 = `P${num1 + 1}`;
                 const type3 = `P${num1 + 2}`;
                 
                 if (counts[firstType] > 0 && counts[type2] > 0 && counts[type3] > 0) {
                      counts[firstType]--;
                      counts[type2]--;
                      counts[type3]--;
                      
                      const nextTiles = [];
                      for (const type in counts) {
                          for (let i = 0; i < counts[type]; i++) {
                              nextTiles.push(type);
                          }
                      }
                      
                      result = canFormSets(nextTiles, otaniCount);
                      
                      counts[firstType]++; // backtrack
                      counts[type2]++;
                      counts[type3]++;
                      
                      if (result) return true;
                 }

                 // 4. é †å­ (é€£ç•ª3æš P1, P2, P3) - å¤§è°·ç‰Œ1æšä½¿ç”¨ (ä¾‹: P1, P2, OT)
                 if (otaniCount >= 1) {
                    // P1, P2, OT
                    if (counts[firstType] > 0 && counts[type2] > 0) {
                        counts[firstType]--;
                        counts[type2]--;
                        
                        const nextTiles = [];
                        for (const type in counts) {
                             for (let i = 0; i < counts[type]; i++) {
                                 nextTiles.push(type);
                             }
                        }
                        
                        result = canFormSets(nextTiles, otaniCount - 1);
                        
                        counts[firstType]++; // backtrack
                        counts[type2]++;
                        
                        if (result) return true;
                    }

                    // P1, OT, P3
                    if (counts[firstType] > 0 && counts[type3] > 0) {
                        counts[firstType]--;
                        counts[type3]--;
                        
                        const nextTiles = [];
                        for (const type in counts) {
                             for (let i = 0; i < counts[type]; i++) {
                                 nextTiles.push(type);
                             }
                        }
                        
                        result = canFormSets(nextTiles, otaniCount - 1);
                        
                        counts[firstType]++; // backtrack
                        counts[type3]++;
                        
                        if (result) return true;
                    }
                    
                    // OT, P2, P3
                    const prevType = `P${num1 - 1}`;
                    if (num1 > 1 && counts[type2] > 0 && counts[type3] > 0) {
                        counts[type2]--;
                        counts[type3]--;
                        
                        const nextTiles = [];
                        for (const type in counts) {
                             for (let i = 0; i < counts[type]; i++) {
                                 nextTiles.push(type);
                             }
                        }
                        
                        result = canFormSets(nextTiles, otaniCount - 1);
                        
                        counts[type2]++;
                        counts[type3]++;
                        
                        if (result) return true;
                    }
                 }
                 // 5. é †å­ (é€£ç•ª3æš P1, P2, P3) - å¤§è°·ç‰Œ2æšä½¿ç”¨ (ä¾‹: P1, OT, OT)
                 if (otaniCount >= 2) {
                    // P1, OT, OT
                    if (counts[firstType] > 0) {
                        counts[firstType]--;
                        
                        const nextTiles = [];
                        for (const type in counts) {
                             for (let i = 0; i < counts[type]; i++) {
                                 nextTiles.push(type);
                             }
                        }
                        
                        result = canFormSets(nextTiles, otaniCount - 2);
                        
                        counts[firstType]++; // backtrack
                        
                        if (result) return true;
                    }
                 }
             }

             return false;
        }

        // -----------------------------------------------------
        // 5. ãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯
        // -----------------------------------------------------

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
         */
        async function sendMessage() {
            if (!isAuthReady || !roomId || !roomRef || !userId) return;

            const messageText = chatInput.value.trim();
            if (messageText === "") return;

            const newMessage = {
                senderId: userId,
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æœ€åˆã®4æ–‡å­—ã‚’ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦ä½¿ç”¨
                senderAlias: `User-${userId.substring(0, 4)}`, 
                text: messageText,
                timestamp: Date.now()
            };

            try {
                // Firestoreã®messagesé…åˆ—ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                await updateDoc(roomRef, {
                    messages: arrayUnion(newMessage)
                });
                chatInput.value = '';
            } catch (error) {
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage("ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
         */
        function renderMessages(messages) {
            messagesList.innerHTML = '';
            
            // æœ€æ–°ã®50ä»¶ã‚’è¡¨ç¤º
            const msgs = messages.slice(-50); 
            
            msgs.forEach(msg => {
                const isMe = msg.senderId === userId;
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message');
                messageElement.classList.add(isMe ? 'my-message' : 'other-message');
                
                const alias = msg.senderAlias || `User-${msg.senderId.substring(0, 4)}`;
                const time = new Date(msg.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="sender">${isMe ? 'ç§' : alias}</span>
                        <span class="time">${time}</span>
                    </div>
                    <div class="message-content">${msg.text}</div>
                `;
                messagesList.appendChild(messageElement);
            });
            // ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        
        /**
         * ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç† (ãƒªãƒ­ãƒ¼ãƒ‰ã§ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹)
         */
        function endGame(winnerId) {
            drawButton.disabled = true;
            checkButton.disabled = true;
            discardSelectedButton.style.display = 'none';

            // å‹è€…è¡¨ç¤º
            if (winnerId) {
                 connectionStatus.textContent = `ã‚²ãƒ¼ãƒ çµ‚äº†ã€‚å‹è€…: ${winnerId === userId ? 'ã‚ãªãŸ' : 'ç›¸æ‰‹'}`;
                 connectionStatus.style.backgroundColor = winnerId === userId ? '#00FF00' : '#FF0000';
            } else {
                 connectionStatus.textContent = `ã‚²ãƒ¼ãƒ çµ‚äº†ã€‚`;
                 connectionStatus.style.backgroundColor = '#AAAAAA';
            }
            
            // 3ç§’å¾Œã«ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
            if (unsubscribeRoom) {
                 unsubscribeRoom();
                 unsubscribeRoom = null;
            }
            setTimeout(() => {
                location.reload(); 
            }, 3000);
        }
        
        /**
         * ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•° (Fisher-Yates)
         */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        
        // -----------------------------------------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        // -----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('create-room-button').addEventListener('click', createRoom);
            document.getElementById('join-room-button').addEventListener('click', () => joinRoom());
            document.getElementById('start-game-button').addEventListener('click', startGame);
            drawButton.onclick = drawTile;
            checkButton.onclick = checkHandForYaku;
            discardSelectedButton.onclick = discardSelectedTile;
            
            // ãƒãƒ£ãƒƒãƒˆé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            initFirebase();
        });

    </script>
    <style>
        :root {
            --tile-bg: #fff;
            --tile-border: #333;
            --deck-bg: #556B2F; /* Olive Drab */
            --player-bg: #f4f4f9;
            --primary-color: #003366; /* Deep Blue (Baseball theme) */
            --secondary-color: #CC3333; /* Red (Baseball theme) */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            font-weight: 700;
            letter-spacing: 2px;
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (ã‚²ãƒ¼ãƒ ã¨ãƒãƒ£ãƒƒãƒˆã‚’ä¸¦ã¹ã‚‹) */
        #game-container {
            display: none;
            gap: 20px;
            flex-wrap: wrap;
        }

        #game-content {
            flex-grow: 1;
            min-width: 450px;
        }
        
        /* ç‰Œã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .tile {
            width: 45px;
            height: 60px;
            background-color: var(--tile-bg);
            border: 2px solid var(--tile-border);
            border-radius: 6px;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        /* ç‰Œã®è‰²ä»˜ã‘ (ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ãƒ†ãƒ¼ãƒã«) */
        .tile[data-type^="P1"] { color: #009999; background-color: #E0FFFF; } /* æŠ•æ‰‹ */
        .tile[data-type^="P2"] { color: #8B4513; background-color: #F5F5DC; } /* æ•æ‰‹ */
        .tile[data-type^="P3"] { color: #006400; background-color: #90EE90; } /* ä¸€å¡æ‰‹ (ã‚°ãƒªãƒ¼ãƒ³) */
        .tile[data-type^="P4"] { color: #DAA520; background-color: #FAFAD2; } /* äºŒå¡æ‰‹ */
        .tile[data-type^="P5"] { color: #FF4500; background-color: #FFDAB9; } /* ä¸‰å¡æ‰‹ (èµ¤ç³») */
        .tile[data-type^="P6"] { color: #4169E1; background-color: #ADD8E6; } /* éŠæ’ƒæ‰‹ (é’ç³») */
        .tile[data-type^="P7"] { color: #800080; background-color: #E6E6FA; } /* å·¦ç¿¼æ‰‹ */
        .tile[data-type^="P8"] { color: #2F4F4F; background-color: #D3D3D3; } /* ä¸­å …æ‰‹ (ã‚°ãƒ¬ãƒ¼) */
        .tile[data-type^="P9"] { color: #B8860B; background-color: #F0E68C; } /* å³ç¿¼æ‰‹ */
        
        /* å¤§è°·ç‰Œ (ã‚ªãƒ¼ãƒ«ãƒã‚¤ãƒ†ã‚£) */
        .tile[data-type^="OT"] { 
            color: var(--primary-color); 
            background-color: #FFD700; /* Gold */
            border-color: var(--primary-color);
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        /* è£è¿”ã—ã®ç‰Œï¼ˆå±±æœ­/ç›¸æ‰‹æ‰‹ç‰Œï¼‰ */
        .tile.face-down {
            background-color: var(--deck-bg);
            border-color: #333;
            color: transparent;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            cursor: default;
        }
        .tile.face-down:hover { transform: none; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3); }

        /* ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .board-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .discard-area, .deck-area {
            flex-basis: 48%;
            padding: 10px;
            border-radius: 8px;
            background-color: #e0e0e0;
            text-align: center;
        }

        .discard-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 70px;
            justify-content: center;
        }
        
        .deck-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80px;
            background-color: #d0e0d0;
        }

        .hand-area {
            background-color: var(--player-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
        }

        .tile-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 70px;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #002244; transform: translateY(-1px); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #a32727; transform: translateY(-1px); }
        
        .btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        
        /* é¸æŠä¸­ã®ç‰Œ */
        .tile.selected {
            border: 4px solid var(--secondary-color);
            box-shadow: 0 0 10px var(--secondary-color);
            transform: translateY(-5px);
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        #message-box {
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 700;
            min-height: 30px;
        }
        .message-success { background-color: #e6ffe6; color: var(--secondary-color); border: 1px solid var(--secondary-color); }
        .message-error { background-color: #ffe6e6; color: var(--primary-color); border: 1px solid var(--primary-color); }
        .message-normal { background-color: #f0f8ff; color: #444; border: 1px solid #aaa; }
        
        #connection-status {
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
            background-color: #ccc;
        }
        
        /* ãƒ­ãƒ“ãƒ¼ç”»é¢ */
        #lobby-container {
            text-align: center;
            display: none;
        }
        .input-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .input-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
            width: 150px;
        }
        #user-id-display {
             font-size: 0.8em;
             color: #666;
             margin-top: 10px;
        }
        #player-list {
            margin-top: 10px;
            font-weight: bold;
            color: #555;
        }
        
        /* --- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #chat-container {
            width: 300px;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 12px;
            background-color: #f8f8f8;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        #messages-list {
            flex-grow: 1;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 5px;
            scroll-behavior: smooth;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 10px;
            line-height: 1.4;
            max-width: 90%;
            word-wrap: break-word;
        }

        .message-header {
            font-size: 0.75em;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
        }
        .sender { font-weight: bold; }
        .time { color: #999; }
        .message-content { font-size: 0.9em; }

        .my-message {
            background-color: #e9f0ff; /* Light Blue */
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        .other-message {
            background-color: #fff;
            border: 1px solid #eee;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }

        #chat-input-area {
            display: flex;
            gap: 5px;
        }

        #chat-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 800px) {
            #game-container {
                flex-direction: column;
            }
            #chat-container {
                width: 100%;
                margin-top: 20px;
                max-height: 300px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Firebaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  é‡çƒãƒ‰ãƒ³ã‚¸ãƒ£ãƒ© (2äººå¯¾æˆ¦ï¼†ãƒãƒ£ãƒƒãƒˆ)</h1>
    <p id="loading-message" style="text-align: center; font-weight: bold;">èªè¨¼ä¸­...</p>
    
    <!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
    <div id="lobby-container">
        <div id="connection-status">åŒæœŸå¾…æ©Ÿä¸­...</div>
        <div class="input-group">
            <h2 style="color: var(--secondary-color);">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h2>
            <button id="create-room-button" class="btn btn-secondary">æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
        </div>
        <div class="input-group">
            <h2 style="color: var(--primary-color);">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h2>
            <input type="text" id="room-id-input" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›" maxlength="8">
            <button id="join-room-button" class="btn btn-primary">å‚åŠ </button>
        </div>
        <p id="user-id-display">ã‚ãªãŸã®ID: ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ï¼†ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
    <div id="game-container">
        
        <!-- ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
        <div id="game-content" style="display: none;">
            <h2 id="room-title" style="text-align: center; margin-bottom: 5px;"></h2>
            <p id="player-list" style="text-align: center;"></p>

            <div id="message-box"></div>
            
            <!-- ç›¸æ‰‹ã®æ‰‹ç‰Œã‚¨ãƒªã‚¢ -->
            <div class="hand-area" style="background-color: #e6e6e6;">
                <h2 style="margin-top: 0; color: #555;">å¯¾æˆ¦ç›¸æ‰‹ã®æ‰‹ç‰Œ</h2>
                <div id="opponent-hand-container" class="tile-list">
                    <!-- ç›¸æ‰‹ã®æ‰‹ç‰Œï¼ˆè£è¿”ã—ï¼‰ -->
                </div>
            </div>

            <div class="board-area">
                <!-- å±±æœ­ã‚¨ãƒªã‚¢ -->
                <div class="deck-area">
                    <p style="font-weight: 700;">å±±æœ­ (<span id="deck-count">48</span>)</p>
                    <div class="tile face-down"></div>
                </div>

                <!-- æ¨ã¦ç‰Œã‚¨ãƒªã‚¢ -->
                <div class="discard-area">
                    <p style="font-weight: 700;">æ¨ã¦ç‰Œ</p>
                    <div id="discard-container" class="discard-list">
                        <!-- æ¨ã¦ç‰ŒãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
            
            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ‰‹ç‰Œã‚¨ãƒªã‚¢ -->
            <div class="hand-area">
                <h2 style="margin-top: 0; color: #555;">ã‚ãªãŸã®æ‰‹ç‰Œ (<span id="hand-count">0</span>æš)</h2>
                <p id="current-turn" style="font-weight: bold; padding: 5px; border-radius: 4px; text-align: center;"></p>
                <div id="hand-container" class="tile-list">
                    <!-- ç‰ŒãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="controls">
                <button id="draw-button" class="btn btn-primary" disabled>å±±æœ­ã‹ã‚‰1æšå¼•ã</button>
                <button id="discard-selected-button" class="btn btn-primary" style="display: none;" disabled>é¸æŠã—ãŸç‰Œã‚’æ¨ã¦ã‚‹</button>
                <button id="check-button" class="btn btn-secondary" disabled>å½¹ã‚’åˆ¤å®šã™ã‚‹ (9æšå¿…é ˆ)</button>
                <button id="start-game-button" class="btn btn-secondary" style="display: none;">ã‚²ãƒ¼ãƒ é–‹å§‹ (ãƒ›ã‚¹ãƒˆã®ã¿)</button>
            </div>
            <button class="btn" style="background-color: #777; color: white; margin-top: 15px;" onclick="location.reload()">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
        
        <!-- ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="chat-container">
            <h3 style="margin-top: 0; color: #555;">ãƒ«ãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆ</h3>
            <div id="messages-list">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                <button id="send-button" class="btn btn-secondary">é€ä¿¡</button>
            </div>
        </div>
    </div>

</div>

</body>
</html>
